<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>W&B Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f9fafb">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Apply Inter font and base styling */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        /* Custom styles for sliders */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #3b82f6; /* blue-500 */
            border-radius: 9999px;
            cursor: pointer;
            border: 4px solid #ffffff; /* white */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #3b82f6; /* blue-500 */
            border-radius: 9999px;
            cursor: pointer;
            border: 4px solid #ffffff; /* white */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type="range"]:disabled::-webkit-slider-thumb {
            background: #9ca3af; /* gray-400 */
        }
        input[type="range"]:disabled::-moz-range-thumb {
            background: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

    <div id="app" class="max-w-lg mx-auto">

        <!-- Loading Screen -->
        <div id="loading-screen" class="h-screen flex flex-col justify-center items-center">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-500">Initializing...</p>
        </div>

        <!-- Profile List Screen -->
        <div id="profile-list-screen" class="hidden p-4">
            <header class="flex justify-between items-center mb-4 pt-4">
                <h1 class="text-3xl font-bold tracking-tight">Helicopter Profiles</h1>
                <button id="info-btn" class="text-blue-500 p-2 rounded-full hover:bg-gray-100">
                     <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                </button>
            </header>
             <div class="mb-6">
                 <button id="add-new-profile-btn" class="w-full bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Add New Profile
                </button>
            </div>
            <div id="profiles-container" class="space-y-3">
                <!-- Profiles will be injected here -->
            </div>
        </div>
        
        <!-- Information Screen -->
        <div id="info-screen" class="hidden p-4 flex flex-col h-screen">
            <header class="flex justify-start items-center mb-6 pt-4">
                 <button id="return-from-info-btn" class="text-blue-500 flex items-center font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                    Return
                </button>
            </header>
            <div id="info-content" class="flex-grow">
                <!-- Information/Disclaimer content will go here -->
            </div>
            <div class="py-4">
                 <button id="acknowledge-and-continue-btn" class="w-full bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Acknowledge & Continue
                </button>
            </div>
        </div>


        <!-- Add/Edit Profile Screen -->
        <div id="edit-profile-screen" class="hidden p-4">
             <header class="flex justify-between items-center mb-6 pt-4">
                <h1 id="edit-screen-title" class="text-3xl font-bold tracking-tight">Create Profile</h1>
                <button id="cancel-edit-btn" class="text-blue-500 font-medium">Cancel</button>
            </header>
            <form id="profile-form" class="space-y-4">
                <input type="hidden" id="profile-id">
                <div>
                    <label for="profile-name" class="block text-sm font-medium text-gray-700">Profile Name (e.g., N-Number)</label>
                    <input type="text" id="profile-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="N7087K">
                </div>
                <div>
                    <label for="aircraft-model" class="block text-sm font-medium text-gray-700">Aircraft Model</label>
                    <select id="aircraft-model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option>Robinson R22 Beta II</option>
                        <option>Robinson R44 Raven I</option>
                        <option>Robinson R44 Raven II</option>
                        <option>Robinson R44 Cadet</option>
                    </select>
                </div>
                 <div>
                    <label for="empty-weight" class="block text-sm font-medium text-gray-700">Basic Empty Weight (lbs)</label>
                    <input type="number" step="0.01" id="empty-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="e.g., 884.95">
                </div>
                <div>
                    <label for="empty-weight-cg" class="block text-sm font-medium text-gray-700">Empty Weight Longitudinal CG (in)</label>
                    <input type="number" step="0.01" id="empty-weight-cg" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="e.g., 103.8">
                </div>
                 <div>
                    <label for="empty-weight-lat-cg" class="block text-sm font-medium text-gray-700">Empty Weight Lateral CG (in)</label>
                    <input type="number" step="0.01" id="empty-weight-lat-cg" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="e.g., -0.02">
                </div>
                <div class="flex items-center">
                    <input id="has-aux-tank" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="has-aux-tank" class="ml-2 block text-sm text-gray-900">Aux Tank Installed</label>
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save Profile</button>
                    <button type="button" id="delete-profile-btn" class="w-full mt-3 bg-red-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-600 hidden">Delete Profile</button>
                </div>
            </form>
        </div>

        <!-- Calculator Screen -->
        <div id="calculator-screen" class="hidden">
            <header class="bg-white shadow-sm sticky top-0 z-10">
                <div class="max-w-lg mx-auto p-4 flex justify-between items-center">
                    <button id="back-to-list-btn" class="text-blue-500 flex items-center font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                        Profiles
                    </button>
                    <div class="text-center">
                        <h1 id="calculator-profile-name" class="font-bold text-lg">N7087K</h1>
                        <p id="calculator-aircraft-model" class="text-sm text-gray-500">Robinson R22 Beta II</p>
                    </div>
                    <div class="w-16"></div> <!-- Spacer -->
                </div>
            </header>

            <main class="p-4 space-y-6 pb-24">
                <!-- Inputs -->
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h2 class="font-bold mb-4 text-lg">Loading</h2>
                    
                    <!-- R22 Inputs -->
                    <div id="r22-inputs" class="space-y-4">
                        <div>
                            <label for="r22-pilot-weight" class="block text-sm font-medium text-gray-700">Pilot (Right Seat)</label>
                            <input type="text" inputmode="numeric" id="r22-pilot-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                        </div>
                        <div>
                            <label for="r22-passenger-weight" class="block text-sm font-medium text-gray-700">Passenger (Left Seat)</label>
                            <input type="text" inputmode="numeric" id="r22-passenger-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                        </div>
                        <div>
                            <label for="r22-cargo-weight" class="block text-sm font-medium text-gray-700">Baggage</label>
                            <input type="text" inputmode="numeric" id="r22-cargo-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                        </div>
                    </div>

                    <!-- R44 Inputs -->
                    <div id="r44-inputs" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Left Column -->
                            <div class="space-y-4">
                                <div>
                                    <label for="r44-fwd-pax-weight" class="block text-sm font-medium text-gray-700">Passenger (Left Seat)</label>
                                    <input type="text" inputmode="numeric" id="r44-fwd-pax-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div>
                                    <label for="r44-fwd-bag-left" class="block text-sm font-medium text-gray-700">Baggage (Fwd L)</label>
                                    <input type="text" inputmode="numeric" id="r44-fwd-bag-left" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div id="r44-aft-left-container">
                                    <label for="r44-aft-pax-left" class="block text-sm font-medium text-gray-700">Left Rear Pass+Bagg</label>
                                    <input type="text" inputmode="numeric" id="r44-aft-pax-left" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                            </div>
                            <!-- Right Column -->
                            <div class="space-y-4">
                                <div>
                                    <label for="r44-pilot-weight" class="block text-sm font-medium text-gray-700">Pilot (Right Seat)</label>
                                    <input type="text" inputmode="numeric" id="r44-pilot-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div>
                                    <label for="r44-fwd-bag-right" class="block text-sm font-medium text-gray-700">Baggage (Fwd R)</label>
                                    <input type="text" inputmode="numeric" id="r44-fwd-bag-right" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div id="r44-aft-right-container">
                                    <label for="r44-aft-pax-right" class="block text-sm font-medium text-gray-700">Right Rear Pass+Bagg</label>
                                    <input type="text" inputmode="numeric" id="r44-aft-pax-right" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fuel Sliders (Common) -->
                    <div class="pt-4 space-y-4">
                        <div>
                            <div class="flex justify-between items-center">
                                <label for="main-fuel-slider" class="block text-sm font-medium text-gray-700">Main Tank Fuel</label>
                                <span id="main-fuel-label" class="text-sm font-medium text-gray-900">0.0 gal</span>
                            </div>
                            <input type="range" id="main-fuel-slider" min="0" max="16.9" step="0.1" value="0" class="mt-1 w-full">
                        </div>
                        <div id="aux-fuel-container">
                            <div class="flex justify-between items-center">
                                <label for="aux-fuel-slider" class="block text-sm font-medium text-gray-700">Aux Tank Fuel</label>
                                <span id="aux-fuel-label" class="text-sm font-medium text-gray-900">0.0 gal</span>
                            </div>
                            <input type="range" id="aux-fuel-slider" min="0" max="9.4" step="0.1" value="0" class="mt-1 w-full">
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h2 class="font-bold mb-4 text-lg">Results</h2>
                    
                    <div class="mb-4 text-center">
                        <button id="recommended-fuel-btn" class="bg-gray-200 text-gray-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 w-full">
                            See Recommended Fuel
                        </button>
                        <p id="max-fuel-text" class="text-center text-sm text-gray-600 mt-2 hidden"></p>
                    </div>

                    <div id="weight-status-box" class="p-4 rounded-lg text-center transition-colors duration-200 mb-4">
                        <p class="text-sm font-medium uppercase tracking-wider">Total Weight</p>
                        <p id="total-weight-display" class="text-3xl font-bold">0.00 lbs</p>
                        <p id="weight-only-status-text" class="font-semibold text-lg mt-1">OK</p>
                    </div>
                    
                    <!-- DUAL GRAPHS -->
                    <div id="charts-container" class="space-y-6">
                        <div>
                            <h3 class="font-semibold text-md mb-2">Longitudinal CG Envelope</h3>
                            <div id="longitudinal-cg-chart" class="relative w-full aspect-video bg-gray-100 rounded-lg p-2">
                                 <!-- Chart will be rendered here by JS -->
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-md">Lateral CG Envelope</h3>
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <div class="flex items-center">
                                        <span class="h-2 w-2 bg-black rounded-full mr-1"></span>
                                        <span>= CG at Zero Fuel</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="h-2 w-2 bg-red-500 rounded-full mr-1"></span>
                                        <span>= CG at Takeoff</span>
                                    </div>
                                </div>
                            </div>
                            <div id="lateral-cg-chart" class="relative w-full aspect-[2.5/1] bg-gray-100 rounded-lg p-2">
                                 <!-- Chart will be rendered here by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Table -->
                    <div id="results-table-container" class="mt-6">
                        <!-- Table will be injected here -->
                    </div>
                </div>
            </main>
        </div>

    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- PWA SERVICE WORKER REGISTRATION ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => console.log('Service Worker registered! Scope: ', registration.scope))
                        .catch(err => console.log('Service Worker registration failed: ', err));
                });
            }
            
            // --- AIRCRAFT DATA STORE ---
            const AIRCRAFT_DATA = {
                "Robinson R22 Beta II": {
                    maxGrossWeight: 1370,
                    fuelWeightPerGallon: 6,
                    stations: {
                        pilot:     { longArm: 78.0, latArm: 10.7 },
                        passenger: { longArm: 78.0, latArm: -9.3 },
                        baggage:   { longArm: 78.0, latArm: -9.3 }, 
                    },
                    longCgLimits: [
                        { weight: 922, forward: 92.0 },
                        { weight: 1370, forward: 98.2 }
                    ],
                    aftCgLimit: 100.4,
                    latLongEnvelope: [
                        { long: 95.5, lat: 0.8 }, { long: 95.5, lat: -2.2 },
                        { long: 97.5, lat: -2.2 }, { long: 101.5, lat: -0.5 },
                        { long: 101.5, lat: 1.2 }, { long: 97.5, lat: 2.6 }
                    ],
                    fuelTanks: {
                        main: { capacity: 16.9, longArm: 108.6, latArm: -11.0 },
                        aux: { capacity: 9.4, longArm: 103.8, latArm: 11.2 }
                    },
                    graphScales: {
                        long: { minWeight: 900, maxWeight: 1400, minCg: 94, maxCg: 102 },
                        lat: { minLongCg: 95, maxLongCg: 102, minLatCg: -3, maxLatCg: 3 }
                    }
                },
                "Robinson R44 Raven I": {
                    maxGrossWeight: 2400,
                    fuelWeightPerGallon: 6,
                    stations: {
                        pilot: { longArm: 49.5, latArm: 12.2 },
                        fwdPax: { longArm: 49.5, latArm: -10.4 },
                        fwdBagRight: { longArm: 44.0, latArm: 11.5 },
                        fwdBagLeft: { longArm: 44.0, latArm: -11.5 },
                        aftPaxRight: { longArm: 79.5, latArm: 12.2 },
                        aftPaxLeft: { longArm: 79.5, latArm: -12.2 },
                    },
                    longCgLimits: [ 
                        { weight: 1600, forward: 92.0 },
                        { weight: 2400, forward: 99.0 }
                    ],
                    aftCgLimit: 102.0,
                    latLongEnvelope: [ 
                        { long: 96, lat: 2.5 }, { long: 101, lat: 4.0 },
                        { long: 104, lat: 2.0 }, { long: 104, lat: -2.0 },
                        { long: 101, lat: -4.0 }, { long: 96, lat: -2.5 }
                    ],
                    fuelTanks: {
                        main: { capacity: 29.5, longArm: 106.0, latArm: -13.5 },
                        aux: { capacity: 17.0, longArm: 102.0, latArm: 13.0 }
                    },
                     graphScales: {
                        long: { minWeight: 1400, maxWeight: 2500, minCg: 91, maxCg: 103 },
                        lat: { minLongCg: 95, maxLongCg: 105, minLatCg: -5, maxLatCg: 5 }
                    }
                },
                "Robinson R44 Raven II": {
                    maxGrossWeight: 2500,
                    fuelWeightPerGallon: 6,
                    stations: {
                        pilot: { longArm: 49.5, latArm: 12.2 },
                        fwdPax: { longArm: 49.5, latArm: -10.4 },
                        fwdBagRight: { longArm: 44.0, latArm: 11.5 },
                        fwdBagLeft: { longArm: 44.0, latArm: -11.5 },
                        aftPaxRight: { longArm: 79.5, latArm: 12.2 },
                        aftPaxLeft: { longArm: 79.5, latArm: -12.2 },
                    },
                    longCgLimits: [
                        { weight: 1600, forward: 92.0 },
                        { weight: 2500, forward: 100.0 }
                    ],
                    aftCgLimit: 102.0,
                    latLongEnvelope: [ 
                        { long: 96, lat: 2.5 }, { long: 101, lat: 4.0 },
                        { long: 104, lat: 2.0 }, { long: 104, lat: -2.0 },
                        { long: 101, lat: -4.0 }, { long: 96, lat: -2.5 }
                    ],
                    fuelTanks: {
                        main: { capacity: 29.5, longArm: 106.0, latArm: -13.5 },
                        aux: { capacity: 17.0, longArm: 102.0, latArm: 13.0 }
                    },
                     graphScales: {
                        long: { minWeight: 1500, maxWeight: 2600, minCg: 91, maxCg: 103 },
                        lat: { minLongCg: 95, maxLongCg: 105, minLatCg: -5, maxLatCg: 5 }
                    }
                },
                "Robinson R44 Cadet": {
                    maxGrossWeight: 2200,
                    fuelWeightPerGallon: 6,
                    stations: {
                        pilot: { longArm: 49.5, latArm: 12.2 },
                        fwdPax: { longArm: 49.5, latArm: -10.4 },
                        fwdBagRight: { longArm: 44.0, latArm: 11.5 },
                        fwdBagLeft: { longArm: 44.0, latArm: -11.5 },
                        aftCompartmentRight: { longArm: 78.0, latArm: 12.2 },
                        aftCompartmentLeft: { longArm: 78.0, latArm: -12.2 },
                    },
                    longCgLimits: [
                        { weight: 1400, forward: 93.0 },
                        { weight: 2200, forward: 99.0 }
                    ],
                    aftCgLimit: 102.0,
                    latLongEnvelope: [ // Placeholder, needs POH data
                        { long: 96, lat: 2.5 }, { long: 101, lat: 4.0 },
                        { long: 104, lat: 2.0 }, { long: 104, lat: -2.0 },
                        { long: 101, lat: -4.0 }, { long: 96, lat: -2.5 }
                    ],
                    fuelTanks: {
                        main: { capacity: 29.5, longArm: 106.0, latArm: -13.5 },
                        aux: { capacity: 17.0, longArm: 102.0, latArm: 13.0 }
                    },
                     graphScales: {
                        long: { minWeight: 1300, maxWeight: 2300, minCg: 92, maxCg: 103 },
                        lat: { minLongCg: 95, maxLongCg: 105, minLatCg: -5, maxLatCg: 5 }
                    }
                }
            };

            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-wb-app';

            // --- DOM ELEMENTS ---
            const screens = {
                loading: document.getElementById('loading-screen'),
                profileList: document.getElementById('profile-list-screen'),
                editProfile: document.getElementById('edit-profile-screen'),
                calculator: document.getElementById('calculator-screen'),
                info: document.getElementById('info-screen')
            };
            const profileForm = document.getElementById('profile-form');
            const profilesContainer = document.getElementById('profiles-container');
            const deleteProfileBtn = document.getElementById('delete-profile-btn');

            // --- APP STATE ---
            let appState = {
                isAuthReady: false,
                userId: null,
                db: null,
                auth: null,
                currentScreen: 'loading',
                profiles: [],
                activeProfile: null,
                unsubscribe: null // To detach Firestore listener
            };

            // --- UI NAVIGATION ---
            function navigate(screenName) {
                appState.currentScreen = screenName;
                Object.keys(screens).forEach(key => {
                    screens[key].classList.add('hidden');
                });
                if (screens[screenName]) {
                    screens[screenName].classList.remove('hidden');
                }
                
                if (screenName === 'profileList') {
                    renderProfileList();
                }
            }
            
            // --- RENDER FUNCTIONS ---
            function renderProfileList() {
                profilesContainer.innerHTML = '';
                if (appState.profiles.length === 0) {
                    profilesContainer.innerHTML = `<div class="text-center text-gray-500 p-8 bg-white rounded-lg shadow-sm">
                        <p>No helicopter profiles found.</p>
                        <p class="mt-2">Tap the button above to add your first one.</p>
                    </div>`;
                } else {
                    appState.profiles.forEach(profile => {
                        const div = document.createElement('div');
                        div.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50';
                        div.innerHTML = `
                            <div>
                                <p class="font-bold text-lg">${profile.name}</p>
                                <p class="text-sm text-gray-500">${profile.model}</p>
                            </div>
                            <button data-id="${profile.id}" class="edit-btn text-gray-400 hover:text-blue-500 p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L15.232 5.232z" /></svg>
                            </button>
                        `;
                        div.addEventListener('click', (e) => {
                            if (e.target.closest('.edit-btn')) {
                                const id = e.target.closest('.edit-btn').dataset.id;
                                const profileToEdit = appState.profiles.find(p => p.id === id);
                                showEditScreen(profileToEdit);
                            } else {
                                const activeProfile = appState.profiles.find(p => p.id === profile.id);
                                showCalculatorScreen(activeProfile);
                            }
                        });
                        profilesContainer.appendChild(div);
                    });
                }
            }

            function showEditScreen(profile = null) {
                profileForm.reset();
                if (profile) {
                    document.getElementById('edit-screen-title').innerText = 'Edit Profile';
                    document.getElementById('profile-id').value = profile.id;
                    document.getElementById('profile-name').value = profile.name;
                    document.getElementById('aircraft-model').value = profile.model;
                    document.getElementById('empty-weight').value = profile.emptyWeight;
                    document.getElementById('empty-weight-cg').value = profile.emptyWeightCG;
                    document.getElementById('empty-weight-lat-cg').value = profile.emptyWeightLatCG;
                    document.getElementById('has-aux-tank').checked = profile.hasAuxTank;
                    deleteProfileBtn.classList.remove('hidden');
                } else {
                    document.getElementById('edit-screen-title').innerText = 'Create Profile';
                    document.getElementById('profile-id').value = '';
                    document.getElementById('aircraft-model').value = 'Robinson R22 Beta II';
                    document.getElementById('profile-name').value = '';
                    document.getElementById('empty-weight').value = '';
                    document.getElementById('empty-weight-cg').value = '';
                    document.getElementById('empty-weight-lat-cg').value = '';
                    document.getElementById('has-aux-tank').checked = true;
                    deleteProfileBtn.classList.add('hidden');
                }
                navigate('editProfile');
            }
            
            function showCalculatorScreen(profile) {
                if (!profile) return;
                appState.activeProfile = profile;
                
                const aircraftData = AIRCRAFT_DATA[profile.model];
                if (!aircraftData) return;

                document.getElementById('calculator-profile-name').innerText = profile.name;
                document.getElementById('calculator-aircraft-model').innerText = profile.model;

                // Show/hide correct input sections
                const r22Inputs = document.getElementById('r22-inputs');
                const r44Inputs = document.getElementById('r44-inputs');
                const r44AftRight = document.getElementById('r44-aft-right-container');
                const r44AftLeft = document.getElementById('r44-aft-left-container');

                if (profile.model.includes('R44')) {
                    r22Inputs.classList.add('hidden');
                    r44Inputs.classList.remove('hidden');
                    if (profile.model === 'Robinson R44 Cadet') {
                        r44AftRight.classList.add('hidden');
                        r44AftLeft.classList.add('hidden');
                    } else {
                        r44AftRight.classList.remove('hidden');
                        r44AftLeft.classList.remove('hidden');
                    }
                } else {
                    r22Inputs.classList.remove('hidden');
                    r44Inputs.classList.add('hidden');
                }

                // Reset all possible inputs
                ['r22-pilot-weight', 'r22-passenger-weight', 'r22-cargo-weight', 'r44-pilot-weight', 'r44-fwd-pax-weight', 'r44-fwd-bag-right', 'r44-fwd-bag-left', 'r44-aft-pax-right', 'r44-aft-pax-left'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });

                // Dynamically set fuel slider max values and visibility
                const auxFuelContainer = document.getElementById('aux-fuel-container');
                const auxSlider = document.getElementById('aux-fuel-slider');
                document.getElementById('main-fuel-slider').max = aircraftData.fuelTanks.main.capacity;
                document.getElementById('main-fuel-slider').value = 0;
                
                if (profile.hasAuxTank) {
                    auxFuelContainer.classList.remove('opacity-50', 'pointer-events-none');
                    auxSlider.disabled = false;
                    auxSlider.max = aircraftData.fuelTanks.aux.capacity;
                } else {
                    auxFuelContainer.classList.add('opacity-50', 'pointer-events-none');
                    auxSlider.disabled = true;
                }
                auxSlider.value = 0;

                navigate('calculator');
                updateCalculation();
            }

            // --- CALCULATION LOGIC ---
            function calculateWb() {
                const profile = appState.activeProfile;
                if (!profile) return null;
                
                const aircraftData = AIRCRAFT_DATA[profile.model];
                if (!aircraftData || Object.keys(aircraftData).length === 0) {
                    alert(`Weight and Balance data for ${profile.model} is not available yet. Calculations will be incorrect.`);
                    return null;
                }

                const stations = [];
                let totalWeight = parseFloat(profile.emptyWeight);
                let totalLongMoment = totalWeight * parseFloat(profile.emptyWeightCG);
                let totalLatMoment = totalWeight * parseFloat(profile.emptyWeightLatCG);
                
                stations.push({ item: 'Empty Weight', weight: totalWeight.toFixed(2), longArm: parseFloat(profile.emptyWeightCG).toFixed(2), longMoment: totalLongMoment.toFixed(2), latArm: parseFloat(profile.emptyWeightLatCG).toFixed(2), latMoment: totalLatMoment.toFixed(2) });

                const addLoad = (name, weight, station) => {
                    if (weight > 0) {
                        const longMoment = weight * station.longArm;
                        const latMoment = weight * station.latArm;
                        totalWeight += weight;
                        totalLongMoment += longMoment;
                        totalLatMoment += latMoment;
                        stations.push({ item: name, weight: weight.toFixed(2), longArm: station.longArm.toFixed(2), longMoment: longMoment.toFixed(2), latArm: station.latArm.toFixed(2), latMoment: latMoment.toFixed(2) });
                    }
                };

                if (profile.model.includes('R44')) {
                    const pilot = parseFloat(document.getElementById('r44-pilot-weight').value) || 0;
                    const fwdPax = parseFloat(document.getElementById('r44-fwd-pax-weight').value) || 0;
                    const fwdBagRight = parseFloat(document.getElementById('r44-fwd-bag-right').value) || 0;
                    const fwdBagLeft = parseFloat(document.getElementById('r44-fwd-bag-left').value) || 0;
                    addLoad('Pilot', pilot, aircraftData.stations.pilot);
                    addLoad('Fwd Pax', fwdPax, aircraftData.stations.fwdPax);
                    addLoad('Fwd Bag R', fwdBagRight, aircraftData.stations.fwdBagRight);
                    addLoad('Fwd Bag L', fwdBagLeft, aircraftData.stations.fwdBagLeft);
                    
                    if (profile.model !== 'Robinson R44 Cadet') {
                        const aftPaxRight = parseFloat(document.getElementById('r44-aft-pax-right').value) || 0;
                        const aftPaxLeft = parseFloat(document.getElementById('r44-aft-pax-left').value) || 0;
                        addLoad('Aft Pax R', aftPaxRight, aircraftData.stations.aftPaxRight);
                        addLoad('Aft Pax L', aftPaxLeft, aircraftData.stations.aftPaxLeft);
                    } else {
                        const aftCompRight = parseFloat(document.getElementById('r44-aft-pax-right').value) || 0;
                        const aftCompLeft = parseFloat(document.getElementById('r44-aft-pax-left').value) || 0;
                        addLoad('Aft Comp R', aftCompRight, aircraftData.stations.aftCompartmentRight);
                        addLoad('Aft Comp L', aftCompLeft, aircraftData.stations.aftCompartmentLeft);
                    }
                } else { // R22
                    const pilot = parseFloat(document.getElementById('r22-pilot-weight').value) || 0;
                    const passenger = parseFloat(document.getElementById('r22-passenger-weight').value) || 0;
                    const cargo = parseFloat(document.getElementById('r22-cargo-weight').value) || 0;
                    addLoad('Pilot', pilot, aircraftData.stations.pilot);
                    addLoad('Passenger', passenger, aircraftData.stations.passenger);
                    addLoad('Baggage', cargo, aircraftData.stations.baggage);
                }
                
                const zeroFuelWeight = totalWeight;
                const zeroFuelLongCg = totalWeight > 0 ? totalLongMoment / totalWeight : 0;
                const zeroFuelLatCg = totalWeight > 0 ? totalLatMoment / totalWeight : 0;

                const mainFuelGal = parseFloat(document.getElementById('main-fuel-slider').value);
                const auxFuelGal = parseFloat(document.getElementById('aux-fuel-slider').value);
                const mainFuelWeight = mainFuelGal * aircraftData.fuelWeightPerGallon;
                addLoad('Main Fuel', mainFuelWeight, aircraftData.fuelTanks.main);
                if (profile.hasAuxTank) {
                    const auxFuelWeight = auxFuelGal * aircraftData.fuelWeightPerGallon;
                    addLoad('Aux Fuel', auxFuelWeight, aircraftData.fuelTanks.aux);
                }

                const finalLongCg = totalWeight > 0 ? totalLongMoment / totalWeight : 0;
                const finalLatCg = totalWeight > 0 ? totalLatMoment / totalWeight : 0;

                const isOverweight = totalWeight > aircraftData.maxGrossWeight;
                
                const [p1, p2] = aircraftData.longCgLimits;
                const forwardCgLimit = p1.forward + ((totalWeight - p1.weight) / (p2.weight - p1.weight)) * (p2.forward - p1.forward);
                const isLongCgOutOfLimits = finalLongCg < forwardCgLimit || finalLongCg > aircraftData.aftCgLimit;

                let isLatCgOutOfLimits = false;
                const poly = aircraftData.latLongEnvelope;
                let inside = false;
                for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
                    const xi = poly[i].long, yi = poly[i].lat;
                    const xj = poly[j].long, yj = poly[j].lat;
                    const intersect = ((yi > finalLatCg) != (yj > finalLatCg))
                        && (finalLongCg < (xj - xi) * (finalLatCg - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }
                isLatCgOutOfLimits = !inside;

                return { 
                    totalWeight, finalLongCg, finalLatCg, 
                    isOverweight, isLongCgOutOfLimits, isLatCgOutOfLimits, 
                    stations, totalLongMoment, totalLatMoment,
                    zeroFuelWeight, zeroFuelLongCg, zeroFuelLatCg,
                    forwardCgLimit
                };
            }
            
            // --- INPUT VALIDATION & UPDATE ---
            function updateCalculation(isRecommendedFuel = false) {
                if (!isRecommendedFuel) {
                     document.getElementById('max-fuel-text').classList.add('hidden');
                }
                
                const weightStatusBox = document.getElementById('weight-status-box');
                const totalWeightDisplay = document.getElementById('total-weight-display');
                const weightOnlyStatusText = document.getElementById('weight-only-status-text');

                const numberOnlyRegex = /^\d*\.?\d*$/;
                let invalidInput = false;
                const inputsToCheck = appState.activeProfile.model.includes('R44') 
                    ? ['r44-pilot-weight', 'r44-fwd-pax-weight', 'r44-fwd-bag-right', 'r44-fwd-bag-left', 'r44-aft-pax-right', 'r44-aft-pax-left']
                    : ['r22-pilot-weight', 'r22-passenger-weight', 'r22-cargo-weight'];

                inputsToCheck.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && !numberOnlyRegex.test(el.value)) {
                        invalidInput = true;
                    }
                });

                if (invalidInput) {
                    weightStatusBox.className = 'p-4 rounded-lg text-center bg-red-100 text-red-700';
                    totalWeightDisplay.textContent = 'Error';
                    weightOnlyStatusText.textContent = 'Invalid Input';
                    document.getElementById('results-table-container').innerHTML = '';
                    document.getElementById('longitudinal-cg-chart').innerHTML = '';
                    document.getElementById('lateral-cg-chart').innerHTML = '';
                    return;
                }

                const results = calculateWb();
                if (!results) return;

                if (results.totalWeight > 1000000) {
                    weightStatusBox.className = 'p-4 rounded-lg text-center bg-red-100 text-red-700';
                    totalWeightDisplay.textContent = 'Error';
                    weightOnlyStatusText.textContent = 'Value Exceeds Limit';
                    document.getElementById('results-table-container').innerHTML = '';
                    document.getElementById('longitudinal-cg-chart').innerHTML = '';
                    document.getElementById('lateral-cg-chart').innerHTML = '';
                    return;
                }
                
                document.getElementById('main-fuel-label').textContent = `${parseFloat(document.getElementById('main-fuel-slider').value).toFixed(1)} gal`;
                document.getElementById('aux-fuel-label').textContent = `${parseFloat(document.getElementById('aux-fuel-slider').value).toFixed(1)} gal`;

                totalWeightDisplay.textContent = `${results.totalWeight.toFixed(2)} lbs`;
                
                if (results.isOverweight) {
                    weightStatusBox.className = 'p-4 rounded-lg text-center bg-red-100 text-red-700';
                    weightOnlyStatusText.textContent = 'OVERWEIGHT';
                } else {
                    weightStatusBox.className = 'p-4 rounded-lg text-center bg-green-100 text-green-700';
                    weightOnlyStatusText.textContent = 'WITHIN WEIGHT LIMITS';
                }

                const tableContainer = document.getElementById('results-table-container');
                const tableRows = results.stations.map(s => `
                    <tr>
                        <td class="py-2 pr-2 text-gray-600">${s.item}</td>
                        <td class="py-2 px-2 text-right">${s.weight}</td>
                        <td class="py-2 px-2 text-right">${s.longArm}</td>
                        <td class="py-2 px-2 text-right">${s.latArm}</td>
                        <td class="py-2 pl-2 text-right">${s.longMoment}</td>
                    </tr>`).join('');
                
                tableContainer.innerHTML = `
                    <h3 class="font-semibold text-md mb-2">Calculation Details</h3>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="py-2 pr-2 font-medium text-left text-gray-500">Item</th>
                                <th class="py-2 px-2 font-medium text-right text-gray-500">Wt</th>
                                <th class="py-2 px-2 font-medium text-right text-gray-500">Long. Arm</th>
                                <th class="py-2 px-2 font-medium text-right text-gray-500">Lat. Arm</th>
                                <th class="py-2 pl-2 font-medium text-right text-gray-500">Long. Mom.</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                        <tfoot>
                            <tr class="border-t-2 font-bold">
                                <td class="py-2 pr-2">Total</td>
                                <td class="py-2 px-2 text-right">${results.totalWeight.toFixed(2)}</td>
                                <td class="py-2 px-2 text-right">${results.finalLongCg.toFixed(2)}</td>
                                <td class="py-2 px-2 text-right">${results.finalLatCg.toFixed(2)}</td>
                                <td class="py-2 pl-2 text-right">${results.totalLongMoment.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>`;

                renderLongitudinalChart(results);
                renderLateralChart(results);
            }
            
            // --- CHART RENDERING ---
            function renderLongitudinalChart(results) {
                const chart = document.getElementById('longitudinal-cg-chart');
                const { totalWeight, finalLongCg, zeroFuelWeight, zeroFuelLongCg } = results;
                const aircraftData = AIRCRAFT_DATA[appState.activeProfile.model];
                const scales = aircraftData.graphScales.long;

                const weightPercent = 100 - ((totalWeight - scales.minWeight) / (scales.maxWeight - scales.minWeight)) * 100;
                const cgPercent = ((finalLongCg - scales.minCg) / (scales.maxCg - scales.minCg)) * 100;
                const zeroFuelWeightPercent = 100 - ((zeroFuelWeight - scales.minWeight) / (scales.maxWeight - scales.minWeight)) * 100;
                const zeroFuelCgPercent = ((zeroFuelLongCg - scales.minCg) / (scales.maxCg - scales.minCg)) * 100;

                const clampedWeightPercent = Math.max(0, Math.min(100, weightPercent));
                const clampedCgPercent = Math.max(0, Math.min(100, cgPercent));
                const clampedZeroFuelWeightPercent = Math.max(0, Math.min(100, zeroFuelWeightPercent));
                const clampedZeroFuelCgPercent = Math.max(0, Math.min(100, zeroFuelCgPercent));

                const [p1, p2] = aircraftData.longCgLimits;
                const aftLimit = aircraftData.aftCgLimit;
                const p1y = 100 - ((p1.weight - scales.minWeight) / (scales.maxWeight - scales.minWeight)) * 100;
                const p1x = ((p1.forward - scales.minCg) / (scales.maxCg - scales.minCg)) * 100;
                const p2y = 100 - ((p2.weight - scales.minWeight) / (scales.maxWeight - scales.minWeight)) * 100;
                const p2x = ((p2.forward - scales.minCg) / (scales.maxCg - scales.minCg)) * 100;
                const p3x = ((aftLimit - scales.minCg) / (scales.maxCg - scales.minCg)) * 100;
                const polygonPoints = `${p1x},${p1y} ${p2x},${p2y} ${p3x},${p2y} ${p3x},${p1y}`;
                const rotorLineX = ((100 - scales.minCg) / (scales.maxCg - scales.minCg)) * 100;

                let dotsHtml = '';
                if (totalWeight > parseFloat(appState.activeProfile.emptyWeight)) {
                     dotsHtml = `
                        <div class="absolute w-3 h-3 bg-black rounded-full -translate-x-1/2 -translate-y-1/2" style="top: ${clampedZeroFuelWeightPercent}%; left: ${clampedZeroFuelCgPercent}%;"></div>
                        <div class="absolute w-3 h-3 bg-red-500 rounded-full -translate-x-1/2 -translate-y-1/2" style="top: ${clampedWeightPercent}%; left: ${clampedCgPercent}%;"></div>
                     `;
                }

                chart.innerHTML = `
                    <span class="absolute bottom-1 left-2 text-sm text-gray-500">Forward</span>
                    <span class="absolute bottom-1 right-2 text-sm text-gray-500">Aft</span>
                    <svg class="w-full h-full" viewbox="0 0 100 100" preserveAspectRatio="none">
                        <polygon points="${polygonPoints}" fill="#e5e7eb" />
                        <line x1="${rotorLineX}" y1="0" x2="${rotorLineX}" y2="100" stroke="#6b7280" stroke-width="0.5" stroke-dasharray="2,2" />
                    </svg>
                    ${dotsHtml}`;
            }
            
            function renderLateralChart(results) {
                const chart = document.getElementById('lateral-cg-chart');
                const { totalWeight, finalLongCg, finalLatCg, zeroFuelLongCg, zeroFuelLatCg } = results;
                const aircraftData = AIRCRAFT_DATA[appState.activeProfile.model];
                const scales = aircraftData.graphScales.lat;

                const longCgPercent = ((finalLongCg - scales.minLongCg) / (scales.maxLongCg - scales.minLongCg)) * 100;
                const latCgPercent = 100 - ((finalLatCg - scales.minLatCg) / (scales.maxLatCg - scales.minLatCg)) * 100;
                const zeroFuelLongCgPercent = ((zeroFuelLongCg - scales.minLongCg) / (scales.maxLongCg - scales.minLongCg)) * 100;
                const zeroFuelLatCgPercent = 100 - ((zeroFuelLatCg - scales.minLatCg) / (scales.maxLatCg - scales.minLatCg)) * 100;

                const clampedLongCgPercent = Math.max(0, Math.min(100, longCgPercent));
                const clampedLatCgPercent = Math.max(0, Math.min(100, latCgPercent));
                const clampedZeroFuelLongCgPercent = Math.max(0, Math.min(100, zeroFuelLongCgPercent));
                const clampedZeroFuelLatCgPercent = Math.max(0, Math.min(100, zeroFuelLatCgPercent));

                const envelopePoints = aircraftData.latLongEnvelope.map(p => {
                    const x = ((p.long - scales.minLongCg) / (scales.maxLongCg - scales.minLongCg)) * 100;
                    const y = 100 - ((p.lat - scales.minLatCg) / (scales.maxLatCg - scales.minLatCg)) * 100;
                    return `${x},${y}`;
                }).join(' ');

                let dotsHtml = '';
                if (totalWeight > parseFloat(appState.activeProfile.emptyWeight)) {
                     dotsHtml = `
                        <div class="absolute w-3 h-3 bg-black rounded-full -translate-x-1/2 -translate-y-1/2" style="top: ${clampedZeroFuelLatCgPercent}%; left: ${clampedZeroFuelLongCgPercent}%;"></div>
                        <div class="absolute w-3 h-3 bg-red-500 rounded-full -translate-x-1/2 -translate-y-1/2" style="top: ${clampedLatCgPercent}%; left: ${clampedLongCgPercent}%;"></div>
                     `;
                }

                chart.innerHTML = `
                    <span class="absolute top-1 left-2 text-sm text-gray-500">Right</span>
                    <span class="absolute bottom-1 left-2 text-sm text-gray-500">Left</span>
                    <svg class="w-full h-full" viewbox="0 0 100 100" preserveAspectRatio="none">
                        <polygon points="${envelopePoints}" fill="#e5e7eb" />
                        <line x1="0" y1="50" x2="100" y2="50" stroke="#6b7280" stroke-width="0.5" stroke-dasharray="2,2" />
                    </svg>
                    ${dotsHtml}`;
            }

            function handleRecommendedFuel() {
                const profile = appState.activeProfile;
                if (!profile) return;
                const aircraftData = AIRCRAFT_DATA[profile.model];

                let zeroFuelWeight = parseFloat(profile.emptyWeight);
                if (profile.model.includes('R44')) {
                    zeroFuelWeight += (parseFloat(document.getElementById('r44-pilot-weight').value) || 0) +
                                      (parseFloat(document.getElementById('r44-fwd-pax-weight').value) || 0) +
                                      (parseFloat(document.getElementById('r44-fwd-bag-right').value) || 0) +
                                      (parseFloat(document.getElementById('r44-fwd-bag-left').value) || 0);
                    if (profile.model !== 'Robinson R44 Cadet') {
                        zeroFuelWeight += (parseFloat(document.getElementById('r44-aft-pax-right').value) || 0) +
                                          (parseFloat(document.getElementById('r44-aft-pax-left').value) || 0);
                    }
                } else {
                    zeroFuelWeight += (parseFloat(document.getElementById('r22-pilot-weight').value) || 0) +
                                      (parseFloat(document.getElementById('r22-passenger-weight').value) || 0) +
                                      (parseFloat(document.getElementById('r22-cargo-weight').value) || 0);
                }
                
                let maxFuelWeight = aircraftData.maxGrossWeight - zeroFuelWeight;
                if (maxFuelWeight < 0) maxFuelWeight = 0;

                let totalFuelGallons = maxFuelWeight / aircraftData.fuelWeightPerGallon;

                let auxFuelGallons = 0;
                let mainFuelGallons = 0;

                const auxCapacity = aircraftData.fuelTanks.aux.capacity;
                const mainCapacity = aircraftData.fuelTanks.main.capacity;

                if (profile.hasAuxTank && totalFuelGallons > 0) {
                    auxFuelGallons = Math.min(totalFuelGallons, auxCapacity);
                    const remainingGallons = totalFuelGallons - auxFuelGallons;
                    mainFuelGallons = Math.min(remainingGallons, mainCapacity);
                } else if (totalFuelGallons > 0) {
                    mainFuelGallons = Math.min(totalFuelGallons, mainCapacity);
                }

                const safeAuxGallons = Math.floor(auxFuelGallons * 10) / 10;
                const safeMainGallons = Math.floor(mainFuelGallons * 10) / 10;

                document.getElementById('aux-fuel-slider').value = safeAuxGallons;
                document.getElementById('main-fuel-slider').value = safeMainGallons;
                
                const maxFuelTextEl = document.getElementById('max-fuel-text');
                maxFuelTextEl.textContent = `Maximum fuel: ${(safeAuxGallons + safeMainGallons).toFixed(1)} gal`;
                maxFuelTextEl.classList.remove('hidden');

                updateCalculation(true); 
            }

            // --- FIRESTORE LOGIC ---
            async function createDefaultProfiles() {
                const profilesToCreate = [
                    {
                        id: 'default-example-r22',
                        data: {
                            name: 'N-example',
                            model: 'Robinson R22 Beta II',
                            emptyWeight: 884.95,
                            emptyWeightCG: 103.8,
                            emptyWeightLatCG: -0.02,
                            hasAuxTank: true
                        }
                    },
                    {
                        id: 'default-example-r44',
                        data: {
                            name: 'N12345',
                            model: 'Robinson R44 Raven II',
                            emptyWeight: 1582.5,
                            emptyWeightCG: 106.6,
                            emptyWeightLatCG: -0.49,
                            hasAuxTank: true
                        }
                    }
                ];

                for (const profile of profilesToCreate) {
                    try {
                        const docRef = doc(appState.db, 'artifacts', appId, 'users', appState.userId, 'aircraft', profile.id);
                        await setDoc(docRef, profile.data);
                    } catch (error) {
                        console.error(`Error creating default profile ${profile.data.name}:`, error);
                    }
                }
            }

            function attachFirestoreListener() {
                if (appState.unsubscribe) appState.unsubscribe();
                if (!appState.db || !appState.userId) return;

                const collectionRef = collection(appState.db, 'artifacts', appId, 'users', appState.userId, 'aircraft');
                appState.unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                    if (snapshot.empty) {
                        createDefaultProfiles();
                    }
                    appState.profiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(appState.currentScreen === 'profileList') {
                        renderProfileList();
                    }
                }, (error) => console.error("Firestore listener error:", error));
            }

            async function handleSaveProfile(e) {
                e.preventDefault();
                const id = document.getElementById('profile-id').value || crypto.randomUUID();
                const profileData = {
                    name: document.getElementById('profile-name').value,
                    model: document.getElementById('aircraft-model').value,
                    emptyWeight: parseFloat(document.getElementById('empty-weight').value),
                    emptyWeightCG: parseFloat(document.getElementById('empty-weight-cg').value),
                    emptyWeightLatCG: parseFloat(document.getElementById('empty-weight-lat-cg').value),
                    hasAuxTank: document.getElementById('has-aux-tank').checked
                };

                if (!profileData.name || !profileData.model || !profileData.emptyWeight || !profileData.emptyWeightCG || isNaN(profileData.emptyWeightLatCG)) {
                    alert("Please fill out all fields.");
                    return;
                }

                try {
                    const docRef = doc(appState.db, 'artifacts', appId, 'users', appState.userId, 'aircraft', id);
                    await setDoc(docRef, profileData, { merge: true });
                    navigate('profileList');
                } catch (error) {
                    console.error("Error saving profile:", error);
                    alert("Could not save profile. Check console for details.");
                }
            }
            
            async function handleDeleteProfile() {
                const id = document.getElementById('profile-id').value;
                if (!id) return;
                
                try {
                    const docRef = doc(appState.db, 'artifacts', appId, 'users', appState.userId, 'aircraft', id);
                    await deleteDoc(docRef);
                    navigate('profileList');
                } catch (error) {
                    console.error("Error deleting profile:", error);
                    alert("Could not delete profile. Check console for details.");
                }
            }

            // --- INITIALIZATION ---
            async function init() {
                try {
                    const app = initializeApp(firebaseConfig);
                    appState.db = getFirestore(app);
                    appState.auth = getAuth(app);

                    onAuthStateChanged(appState.auth, async (user) => {
                        if (user) {
                            appState.userId = user.uid;
                            appState.isAuthReady = true;
                            attachFirestoreListener();
                            navigate('profileList');
                        } else {
                            try {
                                await signInAnonymously(appState.auth);
                            } catch (authError) {
                                 console.error("Authentication failed:", authError);
                                 screens.loading.innerHTML = '<p class="text-red-500">Authentication failed. Please refresh.</p>';
                            }
                        }
                    });
                } catch (e) {
                    console.error("Initialization failed:", e);
                    screens.loading.innerHTML = '<p class="text-red-500">App initialization failed. Check console for details.</p>';
                }
            }

            // --- EVENT LISTENERS ---
            document.getElementById('add-new-profile-btn').addEventListener('click', () => showEditScreen());
            document.getElementById('cancel-edit-btn').addEventListener('click', () => navigate('profileList'));
            profileForm.addEventListener('submit', handleSaveProfile);
            deleteProfileBtn.addEventListener('click', handleDeleteProfile);
            document.getElementById('back-to-list-btn').addEventListener('click', () => navigate('profileList'));
            document.getElementById('recommended-fuel-btn').addEventListener('click', handleRecommendedFuel);
            document.getElementById('info-btn').addEventListener('click', () => navigate('info'));
            document.getElementById('return-from-info-btn').addEventListener('click', () => navigate('profileList'));
            document.getElementById('acknowledge-and-continue-btn').addEventListener('click', () => navigate('profileList'));
            
            const allInputIds = [
                'r22-pilot-weight', 'r22-passenger-weight', 'r22-cargo-weight',
                'r44-pilot-weight', 'r44-fwd-pax-weight', 'r44-fwd-bag-right', 'r44-fwd-bag-left', 'r44-aft-pax-right', 'r44-aft-pax-left',
                'main-fuel-slider', 'aux-fuel-slider'
            ];
            allInputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', () => {
                        updateCalculation();
                    });
                }
            });
            
            // --- START APP ---
            init();
        });
    </script>
</body>
</html>
