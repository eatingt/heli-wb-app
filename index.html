<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>W&B Calculator</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f9fafb">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Apply Inter font and base styling */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        /* Custom styles for sliders */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e5e7eb; /* gray-200 */
            border-radius: 9999px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #3b82f6; /* blue-500 */
            border-radius: 9999px;
            cursor: pointer;
            border: 4px solid #ffffff; /* white */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #3b82f6; /* blue-500 */
            border-radius: 9999px;
            cursor: pointer;
            border: 4px solid #ffffff; /* white */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type="range"]:disabled::-webkit-slider-thumb {
            background: #9ca3af; /* gray-400 */
        }
        input[type="range"]:disabled::-moz-range-thumb {
            background: #9ca3af; /* gray-400 */
        }
        /* Custom styles for the toggle switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6; /* blue-500 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6; /* blue-500 */
        }
        /* Style for profile button hover effect */
        .profile-button:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Screen transition style */
        .screen {
            transition: opacity 0.15s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

    <div id="app" class="max-w-lg mx-auto">

        <div id="disclaimer-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
                <h2 class="text-xl font-bold mb-4">Disclaimer</h2>
                <div class="text-sm text-gray-600 space-y-3 mb-6">
                    <p>This weight & balance and CG calculator app is built using data strictly from the Robinson POH's. This application's logic has been extensively verified to ensure accurate reliability.</p>
                    <p>That being said, this app has no affiliation with Robinson Helicopters. The calculations this app produces are subject to coding errors and inaccuracy.</p>
                    <p class="font-semibold">Remember 14 CFR ยง 91.3(a): "The pilot in command of an aircraft is directly responsible for, and is the final authority as to, the operation of that aircraft."</p>
                </div>
                <button id="acknowledge-disclaimer-btn" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600">Acknowledge & Continue</button>
            </div>
        </div>

        <div id="loading-screen" class="h-screen flex flex-col justify-center items-center screen">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-500">Initializing...</p>
        </div>

        <div id="profile-list-screen" class="hidden screen">
            <header class="sticky top-0 bg-gray-50 z-10 flex justify-between items-center px-4 py-2 border-b border-gray-200">
                <h1 class="text-3xl font-bold tracking-tight">Helicopter Profiles</h1>
                <div class="flex flex-col items-end">
                    <button id="info-btn" class="text-blue-500 p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                    </button>
                    <span class="text-[10px] text-gray-400">S.Vwb.v26.0</span>
                </div>
            </header>
            <div class="p-4">
                 <div class="mb-6">
                      <button id="add-new-profile-btn" class="w-full bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                          Add New Profile
                      </button>
                 </div>
                <div id="profiles-container" class="space-y-3">
                </div>
            </div>
        </div>
        
        <div id="edit-profile-screen" class="hidden screen px-4">
             <header class="flex justify-between items-center mb-6 pt-4">
                <h1 id="edit-screen-title" class="text-3xl font-bold tracking-tight">Create Profile</h1>
                <button id="cancel-edit-btn" class="text-blue-500 font-medium">Cancel</button>
            </header>
            <form id="profile-form" class="space-y-4">
                <input type="hidden" id="profile-id">
                <div>
                    <label for="profile-name" class="block text-sm font-medium text-gray-700">Profile Name (e.g., N-Number)</label>
                    <input type="text" id="profile-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="N12345">
                </div>
                <div>
                    <label for="aircraft-model" class="block text-sm font-medium text-gray-700">Aircraft Model</label>
                    <select id="aircraft-model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option>Robinson R22 Beta II</option>
                        <option>Robinson R44 Raven I</option>
                        <option>Robinson R44 Raven II</option>
                        <option>Robinson R44 Cadet</option>
                        <option>Robinson R66</option>
                    </select>
                </div>
                 <div>
                    <label for="empty-weight" class="block text-sm font-medium text-gray-700">Basic Empty Weight (lbs)</label>
                    <input type="number" step="0.01" id="empty-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="e.g., 884.95">
                </div>
                <div>
                    <label for="empty-weight-cg" class="block text-sm font-medium text-gray-700">Empty Weight Longitudinal CG (in)</label>
                    <input type="number" step="0.01" id="empty-weight-cg" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="e.g., 103.8">
                </div>
                 <div>
                    <label for="empty-weight-lat-cg" class="block text-sm font-medium text-gray-700">Empty Weight Lateral CG (in)</label>
                    <input type="number" step="0.01" id="empty-weight-lat-cg" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="e.g., -0.02">
                </div>
                <div class="flex items-center">
                    <input id="has-aux-tank" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="has-aux-tank" class="ml-2 block text-sm text-gray-900">Aux Tank Installed</label>
                    <span id="aux-tank-r66-notice" class="ml-2 text-sm text-gray-400 hidden">(unable for R66)</span>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input id="enable-color-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="enable-color-checkbox" class="ml-2 block text-sm text-gray-900">Enable Profile Color</label>
                    </div>
                    <div id="color-slider-container" class="transition-opacity">
                        <label for="profile-color" class="block text-sm font-medium text-gray-700">Profile Color</label>
                        <div class="flex items-center mt-1">
                            <input type="range" id="profile-color" min="0" max="370" value="210" class="w-full">
                            <div id="color-preview" class="w-8 h-8 rounded-md ml-4 border border-gray-300"></div>
                        </div>
                    </div>
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save Profile</button>
                    <button type="button" id="delete-profile-btn" class="w-full mt-3 bg-red-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-600 hidden">Delete Profile</button>
                </div>
            </form>
        </div>

        <div id="calculator-screen" class="hidden screen">
            <header class="bg-white shadow-sm sticky top-0 z-10">
                <div class="max-w-lg mx-auto p-4 flex justify-between items-center">
                    <button id="back-to-list-btn" class="text-blue-500 flex items-center font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                        Profiles
                    </button>
                    <div class="text-center">
                        <h1 id="calculator-profile-name" class="font-bold text-lg">N7087K</h1>
                        <p id="calculator-aircraft-model" class="text-sm text-gray-500">Robinson R22 Beta II</p>
                    </div>
                    <div class="w-16"></div> </div>
            </header>

            <main class="p-4 space-y-6 pb-24">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h2 class="font-bold mb-4 text-lg">Loading</h2>
                    
                    <div id="r22-inputs" class="space-y-4">
                        <div>
                            <label for="r22-pilot-weight" class="block text-sm font-medium text-gray-700">Pilot (Right Seat)</label>
                            <input type="text" inputmode="numeric" id="r22-pilot-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                        </div>
                        <div>
                            <label for="r22-passenger-weight" class="block text-sm font-medium text-gray-700">Passenger (Left Seat)</label>
                            <input type="text" inputmode="numeric" id="r22-passenger-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                        </div>
                        <div>
                            <label for="r22-baggage-right" class="block text-sm font-medium text-gray-700">Baggage (Right Seat)</label>
                            <input type="text" inputmode="numeric" id="r22-baggage-right" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                        </div>
                        <div>
                            <label for="r22-baggage-left" class="block text-sm font-medium text-gray-700">Baggage (Left Seat)</label>
                            <input type="text" inputmode="numeric" id="r22-baggage-left" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                        </div>
                    </div>

                    <div id="r44-inputs" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-4">
                                <div>
                                    <label for="r44-fwd-pax-weight" class="block text-sm font-medium text-gray-700">Passenger (Left Seat)</label>
                                    <input type="text" inputmode="numeric" id="r44-fwd-pax-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div>
                                    <label for="r44-fwd-bag-left" class="block text-sm font-medium text-gray-700">Baggage (Fwd L)</label>
                                    <input type="text" inputmode="numeric" id="r44-fwd-bag-left" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div id="r44-aft-left-container">
                                    <label for="r44-aft-pax-left" class="block text-sm font-medium text-gray-700">Left Rear Pass+Bagg</label>
                                    <input type="text" inputmode="numeric" id="r44-aft-pax-left" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="r44-pilot-weight" class="block text-sm font-medium text-gray-700">Pilot (Right Seat)</label>
                                    <input type="text" inputmode="numeric" id="r44-pilot-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div>
                                    <label for="r44-fwd-bag-right" class="block text-sm font-medium text-gray-700">Baggage (Fwd R)</label>
                                    <input type="text" inputmode="numeric" id="r44-fwd-bag-right" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div id="r44-aft-right-container">
                                    <label for="r44-aft-pax-right" class="block text-sm font-medium text-gray-700">Right Rear Pass+Bagg</label>
                                    <input type="text" inputmode="numeric" id="r44-aft-pax-right" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="r66-inputs" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-4">
                                <div>
                                    <label for="r66-fwd-pax-weight" class="block text-sm font-medium text-gray-700">Passenger (Fwd Left)</label>
                                    <input type="text" inputmode="numeric" id="r66-fwd-pax-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div>
                                    <label for="r66-aft-pax-left" class="block text-sm font-medium text-gray-700">Aft Pax (Left)</label>
                                    <input type="text" inputmode="numeric" id="r66-aft-pax-left" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div>
                                    <label for="r66-aft-pax-center" class="block text-sm font-medium text-gray-700">Aft Pax (Center)</label>
                                    <input type="text" inputmode="numeric" id="r66-aft-pax-center" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label for="r66-pilot-weight" class="block text-sm font-medium text-gray-700">Pilot (Fwd Right)</label>
                                    <input type="text" inputmode="numeric" id="r66-pilot-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                 <div>
                                    <label for="r66-aft-pax-right" class="block text-sm font-medium text-gray-700">Aft Pax (Right)</label>
                                    <input type="text" inputmode="numeric" id="r66-aft-pax-right" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                                <div>
                                    <label for="r66-baggage-weight" class="block text-sm font-medium text-gray-700">Baggage Compartment</label>
                                    <input type="text" inputmode="numeric" id="r66-baggage-weight" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 space-y-4">
                        <div>
                            <div class="flex justify-between items-center">
                                <label for="main-fuel-slider" class="block text-sm font-medium text-gray-700">Main Tank Fuel</label>
                                <span id="main-fuel-label" class="text-sm font-medium text-gray-900">0.0 gal</span>
                            </div>
                            <input type="range" id="main-fuel-slider" min="0" max="16.9" step="0.1" value="0" class="mt-1 w-full">
                        </div>
                        <div id="aux-fuel-container">
                            <div class="flex justify-between items-center">
                                <label for="aux-fuel-slider" class="block text-sm font-medium text-gray-700">Aux Tank Fuel</label>
                                <span id="aux-fuel-label" class="text-sm font-medium text-gray-900">0.0 gal</span>
                            </div>
                            <input type="range" id="aux-fuel-slider" min="0" max="9.4" step="0.1" value="0" class="mt-1 w-full">
                        </div>
                        <div class="flex items-center justify-between border-t pt-4 mt-4 border-gray-200">
                            <span id="doors-toggle-label" class="text-sm font-medium text-gray-700">Doors On</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" id="doors-toggle" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="doors-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h2 class="font-bold mb-4 text-lg">Results</h2>
                    
                    <div class="mb-4 text-center">
                        <button id="recommended-fuel-btn" class="bg-gray-200 text-gray-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 w-full">
                            See Recommended Fuel
                        </button>
                        <p id="max-fuel-text" class="text-center text-sm text-gray-600 mt-2 hidden"></p>
                    </div>

                    <div id="weight-status-box" class="p-4 rounded-lg text-center transition-colors duration-200 mb-4">
                        <p class="text-sm font-medium uppercase tracking-wider">Total Weight</p>
                        <p id="total-weight-display" class="text-3xl font-bold">0.00 lbs</p>
                        <p id="weight-only-status-text" class="font-semibold text-lg mt-1">OK</p>
                    </div>
                    
                    <div id="charts-container" class="space-y-6">
                        <div>
                            <h3 class="font-semibold text-md mb-2">Longitudinal CG Envelope</h3>
                            <div id="longitudinal-cg-chart" class="relative w-full aspect-video bg-gray-100 rounded-lg p-2">
                                </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-md">Lateral CG Envelope</h3>
                                <div class="flex items-center space-x-4 text-xs text-gray-500">
                                    <div class="flex items-center">
                                        <span class="h-2 w-2 bg-black rounded-full mr-1"></span>
                                        <span>= CG at Zero Fuel</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="h-2 w-2 bg-red-500 rounded-full mr-1"></span>
                                        <span>= CG at Takeoff</span>
                                    </div>
                                </div>
                            </div>
                            <div id="lateral-cg-chart" class="relative w-full aspect-[2.5/1] bg-gray-100 rounded-lg p-2">
                                </div>
                        </div>
                    </div>

                    <div id="results-table-container" class="mt-6">
                        </div>
                </div>
            </main>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INITIALIZE FIREBASE ---
        // IMPORTANT: Replace these placeholder values with your actual Firebase project credentials
        const firebaseConfig = {
            apiKey: "AIzaSyBCMxazV5paimmyYKcl865GS7PHvel36Ws",
            authDomain: "verticalwb-app.firebaseapp.com",
            projectId: "verticalwb-app",
            storageBucket: "verticalwb-app.firebasestorage.app",
            messagingSenderId: "953304200388",
            appId: "1:953304200388:web:fe0aabf49745504eab4591",
            measurementId: "G-D6H2DQZ2QH"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AIRCRAFT DATA STORE ---
        const AIRCRAFT_DATA = {
            "Robinson R22 Beta II": {
                maxGrossWeight: 1370,
                fuelWeightPerGallon: 6,
                doors: { weight: 10.4, longArm: 77.5, latArm: 0.0 }, // 5.2 each * 2
                stations: {
                    pilot:     { longArm: 78.0, latArm: 10.7 },
                    passenger: { longArm: 78.0, latArm: -9.3 }
                    // Baggage is calculated using pilot/passenger stations based on POH.
                },
                longCgEnvelope: [
                    { cg: 95.36, weight: 905 }, { cg: 95.36, weight: 1275 },
                    { cg: 96.5, weight: 1386 }, { cg: 100.0, weight: 1386 }, //do not adjust
                    { cg: 101.6, weight: 1175 }, { cg: 101.6, weight: 905 }
                ],
                latLongEnvelope: [
                    { long: 95.36, lat: 1 }, { long: 95.36, lat: -0.8 },
                    { long: 97.4, lat: -2.4 }, {long: 98.3, lat: -2.4 }, { long: 101.6, lat: -0.7 },
                    { long: 101.6, lat: 1.2 }, { long: 97.95, lat: 2.8 }
                ],
                fuelTanks: {
                    main: { capacity: 16.9, longArm: 108.6, latArm: -11.0 },
                    aux: { capacity: 9.4, longArm: 103.8, latArm: 11.2 }
                },
                graphScales: {
                    long: { minWeight: 860, maxWeight: 1450, minCg: 95, maxCg: 103 },
                    lat: { minLongCg: 95, maxLongCg: 103, minLatCg: -3, maxLatCg: 3 }
                }
            },
            "Robinson R44 Raven I": {
                maxGrossWeight: 2400,
                fuelWeightPerGallon: 6,
                doors: { weight: 29, longArm: 61.95, latArm: 0.0 }, // (7.5*2*49.4 + 7.0*2*75.4) / 29
                stations: {
                    pilot: { longArm: 49.5, latArm: 12.2 },
                    fwdPax: { longArm: 49.5, latArm: -10.4 },
                    fwdBagRight: { longArm: 44.0, latArm: 11.5 },
                    fwdBagLeft: { longArm: 44.0, latArm: -11.5 },
                    aftPaxRight: { longArm: 79.5, latArm: 12.2 },
                    aftPaxLeft: { longArm: 79.5, latArm: -12.2 },
                },
                longCgEnvelope: [ 
                    { cg: 91.76, weight: 1520 },
                    { cg: 91.76, weight: 2200 },
                    { cg: 93, weight: 2423 },
                    { cg: 95, weight: 2423 },
                    { cg: 98, weight: 2423 },
                    { cg: 102.65, weight: 2000 },
                    { cg: 102.65, weight: 1520 }
                ],
                latLongEnvelope: [ 
                    { long: 91.76, lat: 3.25 }, { long: 100, lat: 3.25 },
                    { long: 102.65, lat: 1.5 }, { long: 102.65, lat: -1.5 },
                    { long: 100, lat: -3.25 }, { long: 91.76, lat: -3.25 }
                ],
                fuelTanks: {
                    main: { capacity: 29.5, longArm: 106.0, latArm: -13.5 },
                    aux: { capacity: 17.0, longArm: 102.0, latArm: 13.0 }
                },
                graphScales: {
                    long: { minWeight: 1400, maxWeight: 2620, minCg: 91, maxCg: 105 },
                    lat: { minLongCg: 91, maxLongCg: 105, minLatCg: -4, maxLatCg: 4 }
                }
            },
            "Robinson R44 Raven II": {
                maxGrossWeight: 2500,
                fuelWeightPerGallon: 6,
                doors: { weight: 29, longArm: 61.95, latArm: 0.0 },
                stations: {
                    pilot: { longArm: 49.5, latArm: 12.2 },
                    fwdPax: { longArm: 49.5, latArm: -10.4 },
                    fwdBagRight: { longArm: 44.0, latArm: 11.5 },
                    fwdBagLeft: { longArm: 44.0, latArm: -11.5 },
                    aftPaxRight: { longArm: 79.5, latArm: 12.2 },
                    aftPaxLeft: { longArm: 79.5, latArm: -12.2 },
                },
                longCgEnvelope: [
                    { cg: 91.76, weight: 1565 },
                    { cg: 91.76, weight: 2300 },
                    { cg: 93, weight: 2531 },
                    { cg: 96, weight: 2531 },
                    { cg: 98, weight: 2531 },
                    { cg: 102.65, weight: 2100 },
                    { cg: 102.65, weight: 1565 }
                ],
                latLongEnvelope: [ 
                    { long: 91.76, lat: 3.25 }, { long: 100, lat: 3.25 },
                    { long: 102.65, lat: 1.5 }, { long: 102.65, lat: -1.5 },
                    { long: 100, lat: -3.25 }, { long: 91.76, lat: -3.25 }
                ],
                fuelTanks: {
                    main: { capacity: 29.5, longArm: 106.0, latArm: -13.5 },
                    aux: { capacity: 17.0, longArm: 102.0, latArm: 13.0 }
                },
                graphScales: {
                    long: { minWeight: 1400, maxWeight: 2600, minCg: 91, maxCg: 105 },
                    lat: { minLongCg: 91, maxLongCg: 105, minLatCg: -4, maxLatCg: 4 }
                }
            },
            "Robinson R44 Cadet": {
                maxGrossWeight: 2200,
                fuelWeightPerGallon: 6,
                doors: { weight: 15, longArm: 49.4, latArm: 0.0 }, // Forward doors only
                stations: {
                    pilot: { longArm: 49.5, latArm: 12.2 },
                    fwdPax: { longArm: 49.5, latArm: -10.4 },
                    fwdBagRight: { longArm: 44.0, latArm: 11.5 },
                    fwdBagLeft: { longArm: 44.0, latArm: -11.5 },
                    aftCompartmentRight: { longArm: 78.0, latArm: 12.2 },
                    aftCompartmentLeft: { longArm: 78.0, latArm: -12.2 },
                },
                longCgEnvelope: [
                    { cg: 91.76, weight: 1530 },
                    { cg: 91.76, weight: 2000 },
                    { cg: 93.0, weight: 2231 },
                    { cg: 100.5, weight: 2231 },
                    { cg: 102.65, weight: 2000 },
                    { cg: 102.65, weight: 1530 }
                ],
                latLongEnvelope: [ // Using R44 Raven I/II data as placeholder
                    { long: 91.76, lat: 3.25 }, { long: 100, lat: 3.25 },
                    { long: 102.65, lat: 1.5 }, { long: 102.65, lat: -1.5 },
                    { long: 100, lat: -3.25 }, { long: 91.76, lat: -3.25 }
                ],
                fuelTanks: {
                    main: { capacity: 29.5, longArm: 106.0, latArm: -13.5 },
                    aux: { capacity: 17.0, longArm: 102.0, latArm: 13.0 }
                },
                graphScales: {
                    long: { minWeight: 1400, maxWeight: 2300, minCg: 91, maxCg: 105 },
                    lat: { minLongCg: 91, maxLongCg: 105, minLatCg: -4, maxLatCg: 4 }
                }
            },
            "Robinson R66": {
                maxGrossWeight: 2700,
                fuelWeightPerGallon: 6.7, // Jet A fuel weight
                // ---- DATA UPDATED PER POH ----
                doors: { weight: 29, longArm: 61.91, latArm: 0.0 }, // 4 doors combined, calculated from POH
                stations: {
                    pilot:     { longArm: 49.0, latArm: 12.2 },   // POH
                    fwdPax:    { longArm: 49.0, latArm: -12.2 },  // POH
                    aftPaxR:   { longArm: 80.0, latArm: 16.0 },   // POH Aft Outboard
                    aftPaxC:   { longArm: 78.0, latArm: 0.0 },    // POH Aft Center
                    aftPaxL:   { longArm: 80.0, latArm: -16.0 },  // POH Aft Outboard
                    baggage:   { longArm: 107.0, latArm: 0.0 }   // POH
                },
                // ---- END UPDATED DATA ----
                longCgEnvelope: [
                    { cg: 90.75, weight: 1350 },
                    { cg: 90.75, weight: 2500 },
                    { cg: 92.0, weight: 2747 },
                    { cg: 98.0, weight: 2747 },
                    { cg: 102.65, weight: 2300 },
                    { cg: 102.65, weight: 1350 }
                ],
                latLongEnvelope: [
                    { long: 90.75, lat: 3.82 }, { long: 100.0, lat: 3.82 },
                    { long: 102.65, lat: 2.5 }, { long: 102.65, lat: -2.5 },
                    { long: 100.0, lat: -3.82 }, { long: 90.75, lat: -3.82 }
                ],
                // ---- DATA UPDATED PER POH ----
                fuelTanks: {
                    main: { capacity: 73.6, longArm: 102.5, latArm: -3.0 } // POH
                    // No aux tank for R66
                },
                // ---- END UPDATED DATA ----
                graphScales: {
                    long: { minWeight: 1250, maxWeight: 2850, minCg: 90, maxCg: 105 },
                    lat: { minLongCg: 90, maxLongCg: 105, minLatCg: -4.5, maxLatCg: 4.5 }
                }
            },
        };
        
        // --- DOM ELEMENTS ---
        const screens = {
            loading: document.getElementById('loading-screen'),
            profileList: document.getElementById('profile-list-screen'),
            editProfile: document.getElementById('edit-profile-screen'),
            calculator: document.getElementById('calculator-screen'),
            info: document.getElementById('info-screen')
        };
        const profileForm = document.getElementById('profile-form');
        const profilesContainer = document.getElementById('profiles-container');
        const deleteProfileBtn = document.getElementById('delete-profile-btn');

        // --- APP STATE ---
        let appState = {
            isAuthReady: false,
            userId: null,
            currentScreen: 'loading',
            profiles: [],
            activeProfile: null,
            unsubscribe: null // To detach Firestore listener
        };

        // --- UI NAVIGATION ---
        function navigate(screenName) {
            const currentScreenKey = appState.currentScreen;
            const nextScreenKey = screenName;

            const currentScreenEl = screens[currentScreenKey];
            const nextScreenEl = screens[nextScreenKey];

            if (currentScreenEl && currentScreenEl !== nextScreenEl) {
                currentScreenEl.classList.add('opacity-0');

                setTimeout(() => {
                    currentScreenEl.classList.add('hidden');

                    if (nextScreenEl) {
                        nextScreenEl.classList.remove('hidden');
                        nextScreenEl.classList.add('opacity-0');

                        requestAnimationFrame(() => {
                            nextScreenEl.classList.remove('opacity-0');
                        });
                    }
                    
                    appState.currentScreen = nextScreenKey;
                    if (nextScreenKey === 'profileList') {
                        renderProfileList();
                    }

                }, 150); 
            } else if (nextScreenEl) { 
                screens.loading.classList.add('opacity-0');
                setTimeout(() => {
                    screens.loading.classList.add('hidden');
                    nextScreenEl.classList.remove('hidden');
                    nextScreenEl.classList.add('opacity-0');
                    requestAnimationFrame(() => {
                        nextScreenEl.classList.remove('opacity-0');
                    });
                    appState.currentScreen = nextScreenKey;
                }, 150);
            }
        }
        
        // --- RENDER FUNCTIONS ---
        function renderProfileList() {
            profilesContainer.innerHTML = '';
            if (appState.profiles.length === 0) {
                profilesContainer.innerHTML = `<div class="text-center text-gray-500 p-8 bg-white rounded-lg shadow-sm">
                    <p>No helicopter profiles found.</p>
                    <p class="mt-2">Tap the button above to add your first one.</p>
                </div>`;
            } else {
                appState.profiles.forEach(profile => {
                    const div = document.createElement('div');
                    div.className = 'profile-button p-4 rounded-lg shadow-sm flex justify-between items-center cursor-pointer transition-all duration-200';
                    
                    if (profile.colorEnabled) {
                        const hue = profile.colorHue ?? 210;
                        if (hue > 360) { // Grayscale
                            const lightness = Math.round((1 - (hue - 361) / 9) * 80);
                            div.style.background = `linear-gradient(to right, white 10%, hsl(0, 0%, ${lightness}%))`;
                        } else { // Color
                            div.style.background = `linear-gradient(to right, white 10%, hsl(${hue}, 70%, 70%))`;
                        }
                    } else {
                        div.style.backgroundColor = 'white';
                    }

                    div.innerHTML = `
                        <div>
                            <p class="font-bold text-lg">${profile.name}</p>
                            <p class="text-sm text-gray-500">${profile.model}</p>
                        </div>
                        <button data-id="${profile.id}" class="edit-btn text-gray-400 hover:text-blue-500 p-2 rounded-full bg-white bg-opacity-50 hover:bg-opacity-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L15.232 5.232z" /></svg>
                        </button>
                    `;
                    div.addEventListener('click', (e) => {
                        if (e.target.closest('.edit-btn')) {
                            const id = e.target.closest('.edit-btn').dataset.id;
                            const profileToEdit = appState.profiles.find(p => p.id === id);
                            showEditScreen(profileToEdit);
                        } else {
                            const activeProfile = appState.profiles.find(p => p.id === profile.id);
                            showCalculatorScreen(activeProfile);
                        }
                    });
                    profilesContainer.appendChild(div);
                });
            }
        }

        function updateAuxTankControls() {
            const aircraftModelSelect = document.getElementById('aircraft-model');
            const hasAuxTankCheckbox = document.getElementById('has-aux-tank');
            const auxTankR66Notice = document.getElementById('aux-tank-r66-notice');

            if (aircraftModelSelect.value === 'Robinson R66') {
                hasAuxTankCheckbox.checked = false;
                hasAuxTankCheckbox.disabled = true;
                auxTankR66Notice.classList.remove('hidden');
            } else {
                hasAuxTankCheckbox.disabled = false;
                auxTankR66Notice.classList.add('hidden');
            }
        }

        function showEditScreen(profile = null) {
            profileForm.reset();
            const enableColorCheckbox = document.getElementById('enable-color-checkbox');
            const colorSliderContainer = document.getElementById('color-slider-container');
            const profileColorSlider = document.getElementById('profile-color');
            const colorPreview = document.getElementById('color-preview');
            profileColorSlider.max = "370"; // Extend slider for grayscale

            const updatePreview = () => {
                const value = profileColorSlider.value;
                if (value > 360) { // Grayscale range
                    const lightness = Math.round((1 - (value - 361) / 9) * 80);
                    colorPreview.style.backgroundColor = `hsl(0, 0%, ${lightness}%)`;
                } else { // Color range
                    colorPreview.style.backgroundColor = `hsl(${value}, 70%, 60%)`;
                }
            };

            const toggleColorControls = () => {
                if (enableColorCheckbox.checked) {
                    colorSliderContainer.classList.remove('opacity-50');
                    profileColorSlider.disabled = false;
                } else {
                    colorSliderContainer.classList.add('opacity-50');
                    profileColorSlider.disabled = true;
                }
            };

            if (profile) {
                document.getElementById('edit-screen-title').innerText = 'Edit Profile';
                document.getElementById('profile-id').value = profile.id;
                document.getElementById('profile-name').value = profile.name;
                document.getElementById('aircraft-model').value = profile.model;
                document.getElementById('empty-weight').value = profile.emptyWeight;
                document.getElementById('empty-weight-cg').value = profile.emptyWeightCG;
                document.getElementById('empty-weight-lat-cg').value = profile.emptyWeightLatCG;
                document.getElementById('has-aux-tank').checked = profile.hasAuxTank;
                profileColorSlider.value = profile.colorHue ?? 210;
                enableColorCheckbox.checked = profile.colorEnabled || false;
                deleteProfileBtn.classList.remove('hidden');
            } else {
                document.getElementById('edit-screen-title').innerText = 'Create Profile';
                document.getElementById('profile-id').value = '';
                document.getElementById('aircraft-model').value = 'Robinson R22 Beta II';
                document.getElementById('profile-name').value = '';
                document.getElementById('empty-weight').value = '';
                document.getElementById('empty-weight-cg').value = '';
                document.getElementById('empty-weight-lat-cg').value = '';
                document.getElementById('has-aux-tank').checked = true;
                profileColorSlider.value = 210; // Default blue
                enableColorCheckbox.checked = false; // Unchecked for new profiles
                deleteProfileBtn.classList.add('hidden');
            }
            
            updateAuxTankControls();
            updatePreview();
            toggleColorControls();

            profileColorSlider.removeEventListener('input', updatePreview); // Prevent multiple listeners
            profileColorSlider.addEventListener('input', updatePreview);
            enableColorCheckbox.removeEventListener('change', toggleColorControls); // Prevent multiple listeners
            enableColorCheckbox.addEventListener('change', toggleColorControls);
            navigate('editProfile');
        }
        
        function showCalculatorScreen(profile) {
            if (!profile) return;
            appState.activeProfile = profile;
            
            const aircraftData = AIRCRAFT_DATA[profile.model];
            if (!aircraftData) return;

            document.getElementById('calculator-profile-name').innerText = profile.name;
            document.getElementById('calculator-aircraft-model').innerText = profile.model;

            const r22Inputs = document.getElementById('r22-inputs');
            const r44Inputs = document.getElementById('r44-inputs');
            const r66Inputs = document.getElementById('r66-inputs'); // New
            const r44AftRight = document.getElementById('r44-aft-right-container');
            const r44AftLeft = document.getElementById('r44-aft-left-container');
            const r44AftRightLabel = r44AftRight.querySelector('label');
            const r44AftLeftLabel = r44AftLeft.querySelector('label');

            // Hide all inputs first
            r22Inputs.classList.add('hidden');
            r44Inputs.classList.add('hidden');
            r66Inputs.classList.add('hidden');

            if (profile.model.includes('R66')) {
                r66Inputs.classList.remove('hidden');
            } else if (profile.model.includes('R44')) {
                r44Inputs.classList.remove('hidden');
                
                r44AftRight.classList.remove('hidden');
                r44AftLeft.classList.remove('hidden');

                if (profile.model === 'Robinson R44 Cadet') {
                    r44AftRightLabel.textContent = 'Aft Compartment (R)';
                    r44AftLeftLabel.textContent = 'Aft Compartment (L)';
                } else {
                    r44AftRightLabel.textContent = 'Right Rear Pass+Bagg';
                    r44AftLeftLabel.textContent = 'Left Rear Pass+Bagg';
                }
            } else { // R22
                r22Inputs.classList.remove('hidden');
            }

            ['r22-pilot-weight', 'r22-passenger-weight', 'r22-baggage-right', 'r22-baggage-left', 
             'r44-pilot-weight', 'r44-fwd-pax-weight', 'r44-fwd-bag-right', 'r44-fwd-bag-left', 'r44-aft-pax-right', 'r44-aft-pax-left',
             'r66-pilot-weight', 'r66-fwd-pax-weight', 'r66-aft-pax-left', 'r66-aft-pax-center', 'r66-aft-pax-right', 'r66-baggage-weight' // New
            ].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });

            const auxFuelContainer = document.getElementById('aux-fuel-container');
            const auxSlider = document.getElementById('aux-fuel-slider');
            document.getElementById('main-fuel-slider').max = aircraftData.fuelTanks.main.capacity;
            document.getElementById('main-fuel-slider').value = 0;
            
            // Updated to be safer: check if aux tank exists in profile AND aircraft data
            if (profile.hasAuxTank && aircraftData.fuelTanks.aux) {
                auxFuelContainer.classList.remove('opacity-50', 'pointer-events-none');
                auxSlider.disabled = false;
                auxSlider.max = aircraftData.fuelTanks.aux.capacity;
                auxSlider.value = 0;
            } else {
                auxFuelContainer.classList.add('opacity-50', 'pointer-events-none');
                auxSlider.disabled = true;
                auxSlider.value = 0;
            }
            
            const doorsToggle = document.getElementById('doors-toggle');
            const doorsToggleLabel = document.getElementById('doors-toggle-label');

            if (profile.model === 'Robinson R22 Beta II') {
                doorsToggle.checked = false;
                doorsToggleLabel.textContent = 'Doors Off';
            } else {
                doorsToggle.checked = true;
                doorsToggleLabel.textContent = 'Doors On';
            }

            navigate('calculator');
            updateCalculation();
        }

        // --- CALCULATION LOGIC ---
        function calculateWb() {
            const profile = appState.activeProfile;
            if (!profile) return null;
            
            const aircraftData = AIRCRAFT_DATA[profile.model];
            if (!aircraftData || Object.keys(aircraftData).length === 0) {
                console.error(`Weight and Balance data for ${profile.model} is not available.`);
                return null;
            }

            const stations = [];
            let emptyWeight = parseFloat(profile.emptyWeight);
            let emptyLongMoment = emptyWeight * parseFloat(profile.emptyWeightCG);
            let emptyLatMoment = emptyWeight * parseFloat(profile.emptyWeightLatCG);
            
            const isDoorsOff = !document.getElementById('doors-toggle').checked;
            
            if (isDoorsOff && aircraftData.doors) {
                const doorData = aircraftData.doors;
                const doorMomentLong = doorData.weight * doorData.longArm;
                const doorMomentLat = doorData.weight * doorData.latArm;
                
                emptyWeight -= doorData.weight;
                emptyLongMoment -= doorMomentLong;
                emptyLatMoment -= doorMomentLat;
            }

            let totalWeight = emptyWeight;
            let totalLongMoment = emptyLongMoment;
            let totalLatMoment = emptyLatMoment;
            
            stations.push({ item: 'Empty Weight', weight: totalWeight.toFixed(2), longArm: (totalLongMoment / totalWeight).toFixed(2), longMoment: totalLongMoment.toFixed(2), latArm: (totalLatMoment / totalWeight).toFixed(2), latMoment: totalLatMoment.toFixed(2) });

            const addLoad = (name, weight, station) => {
                if (weight > 0) {
                    const longMoment = weight * station.longArm;
                    const latMoment = weight * station.latArm;
                    totalWeight += weight;
                    totalLongMoment += longMoment;
                    totalLatMoment += latMoment;
                    stations.push({ item: name, weight: weight.toFixed(2), longArm: station.longArm.toFixed(2), longMoment: longMoment.toFixed(2), latArm: station.latArm.toFixed(2), latMoment: latMoment.toFixed(2) });
                }
            };

            if (profile.model.includes('R66')) {
                const pilot = parseFloat(document.getElementById('r66-pilot-weight').value) || 0;
                const fwdPax = parseFloat(document.getElementById('r66-fwd-pax-weight').value) || 0;
                const aftPaxR = parseFloat(document.getElementById('r66-aft-pax-right').value) || 0;
                const aftPaxC = parseFloat(document.getElementById('r66-aft-pax-center').value) || 0;
                const aftPaxL = parseFloat(document.getElementById('r66-aft-pax-left').value) || 0;
                const baggage = parseFloat(document.getElementById('r66-baggage-weight').value) || 0;
                addLoad('Pilot', pilot, aircraftData.stations.pilot);
                addLoad('Fwd Pax', fwdPax, aircraftData.stations.fwdPax);
                addLoad('Aft Pax R', aftPaxR, aircraftData.stations.aftPaxR);
                addLoad('Aft Pax C', aftPaxC, aircraftData.stations.aftPaxC);
                addLoad('Aft Pax L', aftPaxL, aircraftData.stations.aftPaxL);
                addLoad('Baggage', baggage, aircraftData.stations.baggage);
            } else if (profile.model.includes('R44')) {
                const pilot = parseFloat(document.getElementById('r44-pilot-weight').value) || 0;
                const fwdPax = parseFloat(document.getElementById('r44-fwd-pax-weight').value) || 0;
                const fwdBagRight = parseFloat(document.getElementById('r44-fwd-bag-right').value) || 0;
                const fwdBagLeft = parseFloat(document.getElementById('r44-fwd-bag-left').value) || 0;
                addLoad('Pilot', pilot, aircraftData.stations.pilot);
                addLoad('Fwd Pax', fwdPax, aircraftData.stations.fwdPax);
                addLoad('Fwd Bag R', fwdBagRight, aircraftData.stations.fwdBagRight);
                addLoad('Fwd Bag L', fwdBagLeft, aircraftData.stations.fwdBagLeft);
                
                if (profile.model === 'Robinson R44 Cadet') {
                    const aftCompRight = parseFloat(document.getElementById('r44-aft-pax-right').value) || 0;
                    const aftCompLeft = parseFloat(document.getElementById('r44-aft-pax-left').value) || 0;
                    addLoad('Aft Comp R', aftCompRight, aircraftData.stations.aftCompartmentRight);
                    addLoad('Aft Comp L', aftCompLeft, aircraftData.stations.aftCompartmentLeft);
                } else {
                    const aftPaxRight = parseFloat(document.getElementById('r44-aft-pax-right').value) || 0;
                    const aftPaxLeft = parseFloat(document.getElementById('r44-aft-pax-left').value) || 0;
                    addLoad('Aft Pax R', aftPaxRight, aircraftData.stations.aftPaxRight);
                    addLoad('Aft Pax L', aftPaxLeft, aircraftData.stations.aftPaxLeft);
                }
            } else { // R22
                const pilot = parseFloat(document.getElementById('r22-pilot-weight').value) || 0;
                const passenger = parseFloat(document.getElementById('r22-passenger-weight').value) || 0;
                const baggageRight = parseFloat(document.getElementById('r22-baggage-right').value) || 0;
                const baggageLeft = parseFloat(document.getElementById('r22-baggage-left').value) || 0;
                addLoad('Pilot', pilot, aircraftData.stations.pilot);
                addLoad('Passenger', passenger, aircraftData.stations.passenger);
                addLoad('Baggage (R)', baggageRight, aircraftData.stations.pilot);
                addLoad('Baggage (L)', baggageLeft, aircraftData.stations.passenger);
            }
            
            const zeroFuelWeight = totalWeight;
            const zeroFuelLongCg = totalWeight > 0 ? totalLongMoment / totalWeight : 0;
            const zeroFuelLatCg = totalWeight > 0 ? totalLatMoment / totalWeight : 0;

            const mainFuelGal = parseFloat(document.getElementById('main-fuel-slider').value);
            const auxFuelGal = (profile.hasAuxTank && aircraftData.fuelTanks.aux) ? parseFloat(document.getElementById('aux-fuel-slider').value) : 0;
            const mainFuelWeight = mainFuelGal * aircraftData.fuelWeightPerGallon;
            addLoad('Main Fuel', mainFuelWeight, aircraftData.fuelTanks.main);

            if (profile.hasAuxTank && aircraftData.fuelTanks.aux) {
                const auxFuelWeight = auxFuelGal * aircraftData.fuelWeightPerGallon;
                addLoad('Aux Fuel', auxFuelWeight, aircraftData.fuelTanks.aux);
            }

            const finalLongCg = totalWeight > 0 ? totalLongMoment / totalWeight : 0;
            const finalLatCg = totalWeight > 0 ? totalLatMoment / totalWeight : 0;

            const isOverweight = totalWeight > aircraftData.maxGrossWeight;
            
            const poly = aircraftData.longCgEnvelope;
            let inside = false;
            for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
                const xi = poly[i].cg, yi = poly[i].weight;
                const xj = poly[j].cg, yj = poly[j].weight;
                const intersect = ((yi > totalWeight) != (yj > totalWeight))
                    && (finalLongCg < (xj - xi) * (totalWeight - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            const isLongCgOutOfLimits = !inside;

            let isLatCgOutOfLimits = false;
            const latPoly = aircraftData.latLongEnvelope;
            let latInside = false;
            for (let i = 0, j = latPoly.length - 1; i < latPoly.length; j = i++) {
                const xi = latPoly[i].long, yi = latPoly[i].lat;
                const xj = latPoly[j].long, yj = latPoly[j].lat;
                const intersect = ((yi > finalLatCg) != (yj > finalLatCg))
                    && (finalLongCg < (xj - xi) * (finalLatCg - yi) / (yj - yi) + xi);
                if (intersect) latInside = !latInside;
            }
            isLatCgOutOfLimits = !latInside;

            return { 
                totalWeight, finalLongCg, finalLatCg, 
                isOverweight, isLongCgOutOfLimits, isLatCgOutOfLimits, 
                stations, totalLongMoment, totalLatMoment,
                zeroFuelWeight, zeroFuelLongCg, zeroFuelLatCg
            };
        }
        
        function updateCalculation(isRecommendedFuel = false) {
            if (!isRecommendedFuel) {
                document.getElementById('max-fuel-text').classList.add('hidden');
            }

            if (!appState.activeProfile) return;
            
            const weightStatusBox = document.getElementById('weight-status-box');
            const totalWeightDisplay = document.getElementById('total-weight-display');
            const weightOnlyStatusText = document.getElementById('weight-only-status-text');

            const numberOnlyRegex = /^\d*\.?\d*$/;
            let invalidInput = false;
            const inputsToCheck = appState.activeProfile.model.includes('R66')
                ? ['r66-pilot-weight', 'r66-fwd-pax-weight', 'r66-aft-pax-left', 'r66-aft-pax-center', 'r66-aft-pax-right', 'r66-baggage-weight']
                : appState.activeProfile.model.includes('R44') 
                ? ['r44-pilot-weight', 'r44-fwd-pax-weight', 'r44-fwd-bag-right', 'r44-fwd-bag-left', 'r44-aft-pax-right', 'r44-aft-pax-left']
                : ['r22-pilot-weight', 'r22-passenger-weight', 'r22-baggage-right', 'r22-baggage-left'];

            inputsToCheck.forEach(id => {
                const el = document.getElementById(id);
                if (el && !numberOnlyRegex.test(el.value)) {
                    invalidInput = true;
                }
            });

            if (invalidInput) {
                weightStatusBox.className = 'p-4 rounded-lg text-center bg-red-100 text-red-700';
                totalWeightDisplay.textContent = 'Error';
                weightOnlyStatusText.textContent = 'Invalid Input';
                document.getElementById('results-table-container').innerHTML = '';
                document.getElementById('longitudinal-cg-chart').innerHTML = '';
                document.getElementById('lateral-cg-chart').innerHTML = '';
                return;
            }

            const results = calculateWb();
            if (!results) return;

            if (results.totalWeight > 1000000) {
                weightStatusBox.className = 'p-4 rounded-lg text-center bg-red-100 text-red-700';
                totalWeightDisplay.textContent = 'Error';
                weightOnlyStatusText.textContent = 'Value Exceeds Limit';
                document.getElementById('results-table-container').innerHTML = '';
                document.getElementById('longitudinal-cg-chart').innerHTML = '';
                document.getElementById('lateral-cg-chart').innerHTML = '';
                return;
            }
            
            document.getElementById('main-fuel-label').textContent = `${parseFloat(document.getElementById('main-fuel-slider').value).toFixed(1)} gal`;
            document.getElementById('aux-fuel-label').textContent = `${parseFloat(document.getElementById('aux-fuel-slider').value).toFixed(1)} gal`;

            totalWeightDisplay.textContent = `${results.totalWeight.toFixed(2)} lbs`;
            
            if (results.isOverweight) {
                weightStatusBox.className = 'p-4 rounded-lg text-center bg-red-100 text-red-700';
                weightOnlyStatusText.textContent = 'OVERWEIGHT';
            } else {
                weightStatusBox.className = 'p-4 rounded-lg text-center bg-green-100 text-green-700';
                weightOnlyStatusText.textContent = 'WITHIN WEIGHT LIMITS';
            }

            const tableContainer = document.getElementById('results-table-container');
            const tableRows = results.stations.map(s => `
                <tr>
                    <td class="py-2 pr-2 text-gray-600">${s.item}</td>
                    <td class="py-2 px-2 text-right">${s.weight}</td>
                    <td class="py-2 px-2 text-right">${s.longArm}</td>
                    <td class="py-2 px-2 text-right">${s.latArm}</td>
                    <td class="py-2 pl-2 text-right">${s.longMoment}</td>
                </tr>`).join('');
            
            tableContainer.innerHTML = `
                <h3 class="font-semibold text-md mb-2">Calculation Details</h3>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b">
                            <th class="py-2 pr-2 font-medium text-left text-gray-500">Item</th>
                            <th class="py-2 px-2 font-medium text-right text-gray-500">Wt</th>
                            <th class="py-2 px-2 font-medium text-right text-gray-500">Long. Arm</th>
                            <th class="py-2 px-2 font-medium text-right text-gray-500">Lat. Arm</th>
                            <th class="py-2 pl-2 font-medium text-right text-gray-500">Long. Mom.</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                    <tfoot>
                        <tr class="border-t-2 font-bold">
                            <td class="py-2 pr-2">Total</td>
                            <td class="py-2 px-2 text-right">${results.totalWeight.toFixed(2)}</td>
                            <td class="py-2 px-2 text-right">${results.finalLongCg.toFixed(2)}</td>
                            <td class="py-2 px-2 text-right">${results.finalLatCg.toFixed(2)}</td>
                            <td class="py-2 pl-2 text-right">${results.totalLongMoment.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>`;

            renderLongitudinalChart(results);
            renderLateralChart(results);
        }
        
        function renderLongitudinalChart(results) {
            const chart = document.getElementById('longitudinal-cg-chart');
            const { totalWeight, finalLongCg, zeroFuelWeight, zeroFuelLongCg } = results;
            const aircraftData = AIRCRAFT_DATA[appState.activeProfile.model];
            const scales = aircraftData.graphScales.long;
            
            // --- Dynamically calculate aspect ratio to ensure dots are circular ---
            const chartWidth = chart.clientWidth;
            const chartHeight = chart.clientHeight;
            if (chartHeight === 0) return; // Avoid division by zero if chart is hidden
            const aspectRatio = chartWidth / chartHeight;
            const ry = 2.0; // Base radius on the vertical SVG units
            const rx = ry / aspectRatio; // Correct the horizontal radius based on the container's final aspect ratio

            const weightPercent = 100 - ((totalWeight - scales.minWeight) / (scales.maxWeight - scales.minWeight)) * 100;
            const cgPercent = ((finalLongCg - scales.minCg) / (scales.maxCg - scales.minCg)) * 100;
            const zeroFuelWeightPercent = 100 - ((zeroFuelWeight - scales.minWeight) / (scales.maxWeight - scales.minWeight)) * 100;
            const zeroFuelCgPercent = ((zeroFuelLongCg - scales.minCg) / (scales.maxCg - scales.minCg)) * 100;

            const clampedWeightPercent = Math.max(0, Math.min(100, weightPercent));
            const clampedCgPercent = Math.max(0, Math.min(100, cgPercent));
            const clampedZeroFuelWeightPercent = Math.max(0, Math.min(100, zeroFuelWeightPercent));
            const clampedZeroFuelCgPercent = Math.max(0, Math.min(100, zeroFuelCgPercent));

            const envelopePoints = aircraftData.longCgEnvelope.map(p => {
                const x = ((p.cg - scales.minCg) / (scales.maxCg - scales.minCg)) * 100;
                const y = 100 - ((p.weight - scales.minWeight) / (scales.maxWeight - scales.minWeight)) * 100;
                return `${x},${y}`;
            }).join(' ');

            const rotorLineX = ((100 - scales.minCg) / (scales.maxCg - scales.minCg)) * 100;

            let dotsSvg = '';
            if (totalWeight > parseFloat(appState.activeProfile.emptyWeight)) {
                 dotsSvg = `
                    <ellipse cx="${clampedZeroFuelCgPercent}" cy="${clampedZeroFuelWeightPercent}" rx="${rx}" ry="${ry}" fill="black" />
                    <ellipse cx="${clampedCgPercent}" cy="${clampedWeightPercent}" rx="${rx}" ry="${ry}" fill="#ef4444" />
                `;
            }

            chart.innerHTML = `
                <span class="absolute bottom-1 left-2 text-sm text-gray-500">Forward</span>
                <span class="absolute bottom-1 right-2 text-sm text-gray-500">Aft</span>
                <span class="absolute top-1/2 -translate-y-1/2 text-[10px] font-semibold text-gray-400 tracking-wider" style="right: calc(100% - ${rotorLineX}% + 2px); writing-mode: vertical-rl; transform: translateY(-50%) rotate(180deg);">Main Rotor CL</span>
                <svg class="w-full h-full" viewbox="0 0 100 100" preserveAspectRatio="none">
                    <polygon points="${envelopePoints}" fill="#e5e7eb" />
                    <line x1="${rotorLineX}" y1="0" x2="${rotorLineX}" y2="100" stroke="#6b7280" stroke-width="0.5" stroke-dasharray="2,2" />
                    ${dotsSvg}
                </svg>`;
        }
        
        function renderLateralChart(results) {
            const chart = document.getElementById('lateral-cg-chart');
            const { totalWeight, finalLongCg, finalLatCg, zeroFuelLongCg, zeroFuelLatCg } = results;
            const aircraftData = AIRCRAFT_DATA[appState.activeProfile.model];
            const scales = aircraftData.graphScales.lat;

            // --- Dynamically calculate aspect ratio to ensure dots are circular ---
            const chartWidth = chart.clientWidth;
            const chartHeight = chart.clientHeight;
            if (chartHeight === 0) return; // Avoid division by zero if chart is hidden
            const aspectRatio = chartWidth / chartHeight;
            const ry = 2.2; // Base radius on the vertical SVG units
            const rx = ry / aspectRatio; // Correct the horizontal radius based on the container's final aspect ratio
            
            const longCgPercent = ((finalLongCg - scales.minLongCg) / (scales.maxLongCg - scales.minLongCg)) * 100;
            const latCgPercent = 100 - ((finalLatCg - scales.minLatCg) / (scales.maxLatCg - scales.minLatCg)) * 100;
            const zeroFuelLongCgPercent = ((zeroFuelLongCg - scales.minLongCg) / (scales.maxLongCg - scales.minLongCg)) * 100;
            const zeroFuelLatCgPercent = 100 - ((zeroFuelLatCg - scales.minLatCg) / (scales.maxLatCg - scales.minLatCg)) * 100;

            const clampedLongCgPercent = Math.max(0, Math.min(100, longCgPercent));
            const clampedLatCgPercent = Math.max(0, Math.min(100, latCgPercent));
            const clampedZeroFuelLongCgPercent = Math.max(0, Math.min(100, zeroFuelLongCgPercent));
            const clampedZeroFuelLatCgPercent = Math.max(0, Math.min(100, zeroFuelLatCgPercent));

            const envelopePoints = aircraftData.latLongEnvelope.map(p => {
                const x = ((p.long - scales.minLongCg) / (scales.maxLongCg - scales.minLongCg)) * 100;
                const y = 100 - ((p.lat - scales.minLatCg) / (scales.maxLatCg - scales.minLatCg)) * 100;
                return `${x},${y}`;
            }).join(' ');
            
            let dotsSvg = '';
            if (totalWeight > parseFloat(appState.activeProfile.emptyWeight)) {
                 dotsSvg = `
                    <ellipse cx="${clampedZeroFuelLongCgPercent}" cy="${clampedZeroFuelLatCgPercent}" rx="${rx}" ry="${ry}" fill="black" />
                    <ellipse cx="${clampedLongCgPercent}" cy="${clampedLatCgPercent}" rx="${rx}" ry="${ry}" fill="#ef4444" />
                `;
            }

            chart.innerHTML = `
                <span class="absolute top-1 left-2 text-sm text-gray-500">Right</span>
                <span class="absolute bottom-1 left-2 text-sm text-gray-500">Left</span>
                <span class="absolute top-[calc(50%-1rem)] left-1/2 -translate-x-1/2 text-[10px] font-semibold text-gray-400 tracking-wider">Centerline</span>
                <svg class="w-full h-full" viewbox="0 0 100 100" preserveAspectRatio="none">
                    <polygon points="${envelopePoints}" fill="#e5e7eb" />
                    <line x1="0" y1="50" x2="100" y2="50" stroke="#6b7280" stroke-width="0.5" stroke-dasharray="2,2" />
                    ${dotsSvg}
                </svg>`;
        }

        function handleRecommendedFuel() {
            const profile = appState.activeProfile;
            if (!profile) return;
            const aircraftData = AIRCRAFT_DATA[profile.model];

            let zeroFuelWeight = parseFloat(profile.emptyWeight);
            
            const isDoorsOff = !document.getElementById('doors-toggle').checked;
            if (isDoorsOff && aircraftData.doors) {
                zeroFuelWeight -= aircraftData.doors.weight;
            }

            if (profile.model.includes('R66')) {
                zeroFuelWeight += (parseFloat(document.getElementById('r66-pilot-weight').value) || 0) +
                                  (parseFloat(document.getElementById('r66-fwd-pax-weight').value) || 0) +
                                  (parseFloat(document.getElementById('r66-aft-pax-right').value) || 0) +
                                  (parseFloat(document.getElementById('r66-aft-pax-center').value) || 0) +
                                  (parseFloat(document.getElementById('r66-aft-pax-left').value) || 0) +
                                  (parseFloat(document.getElementById('r66-baggage-weight').value) || 0);
            } else if (profile.model.includes('R44')) {
                zeroFuelWeight += (parseFloat(document.getElementById('r44-pilot-weight').value) || 0) +
                                  (parseFloat(document.getElementById('r44-fwd-pax-weight').value) || 0) +
                                  (parseFloat(document.getElementById('r44-fwd-bag-right').value) || 0) +
                                  (parseFloat(document.getElementById('r44-fwd-bag-left').value) || 0);
                if (profile.model === 'Robinson R44 Cadet') {
                     zeroFuelWeight += (parseFloat(document.getElementById('r44-aft-pax-right').value) || 0) +
                                       (parseFloat(document.getElementById('r44-aft-pax-left').value) || 0);
                } else {
                     zeroFuelWeight += (parseFloat(document.getElementById('r44-aft-pax-right').value) || 0) +
                                       (parseFloat(document.getElementById('r44-aft-pax-left').value) || 0);
                }
            } else { // R22
                zeroFuelWeight += (parseFloat(document.getElementById('r22-pilot-weight').value) || 0) +
                                  (parseFloat(document.getElementById('r22-passenger-weight').value) || 0) +
                                  (parseFloat(document.getElementById('r22-baggage-right').value) || 0) +
                                  (parseFloat(document.getElementById('r22-baggage-left').value) || 0);
            }
            
            let maxFuelWeight = aircraftData.maxGrossWeight - zeroFuelWeight;
            if (maxFuelWeight < 0) maxFuelWeight = 0;

            let totalFuelGallons = maxFuelWeight / aircraftData.fuelWeightPerGallon;

            let auxFuelGallons = 0;
            let mainFuelGallons = 0;

            const auxCapacity = aircraftData.fuelTanks.aux ? aircraftData.fuelTanks.aux.capacity : 0;
            const mainCapacity = aircraftData.fuelTanks.main.capacity;

            // UPDATED: Fuel logic
            if (profile.model === 'Robinson R22 Beta II' && profile.hasAuxTank && totalFuelGallons > 0) {
                // R22 Proportional Logic
                mainFuelGallons = Math.min(totalFuelGallons * 0.65, mainCapacity);
                auxFuelGallons = Math.min(totalFuelGallons * 0.35, auxCapacity);
            } else if (profile.model.includes('R44') && profile.hasAuxTank && totalFuelGallons > 0) {
                // R44 Main Tank First Logic
                mainFuelGallons = Math.min(totalFuelGallons, mainCapacity);
                const remainingGallons = totalFuelGallons - mainFuelGallons;
                auxFuelGallons = Math.min(remainingGallons, auxCapacity);
            } else if (totalFuelGallons > 0) { // No aux tank (applies to all models, including R66)
                mainFuelGallons = Math.min(totalFuelGallons, mainCapacity);
            }

            const safeAuxGallons = Math.floor(auxFuelGallons * 10) / 10;
            const safeMainGallons = Math.floor(mainFuelGallons * 10) / 10;

            document.getElementById('aux-fuel-slider').value = safeAuxGallons;
            document.getElementById('main-fuel-slider').value = safeMainGallons;
            
            const maxFuelTextEl = document.getElementById('max-fuel-text');
            maxFuelTextEl.textContent = `Maximum fuel: ${(safeAuxGallons + safeMainGallons).toFixed(1)} gal`;
            maxFuelTextEl.classList.remove('hidden');

            updateCalculation(true); 
        }
        
        // --- FIREBASE LOGIC ---
        function createDefaultProfiles() {
            const profilesToCreate = [
                { id: 'poh-example-r22', data: { name: 'POH Example - R22', model: 'Robinson R22 Beta II', emptyWeight: 880, emptyWeightCG: 104.0, emptyWeightLatCG: -0.1, hasAuxTank: true, colorHue: 130, colorEnabled: true } },
                { id: 'poh-example-r44-raven1', data: { name: 'POH Example - R44 Raven I', model: 'Robinson R44 Raven I', emptyWeight: 1460, emptyWeightCG: 106.2, emptyWeightLatCG: 0.2, hasAuxTank: true, colorHue: 130, colorEnabled: false } },
                { id: 'poh-example-r44-raven2', data: { name: 'POH Example - R44 Raven II', model: 'Robinson R44 Raven II', emptyWeight: 1510, emptyWeightCG: 106.5, emptyWeightLatCG: 0.2, hasAuxTank: true, colorHue: 0, colorEnabled: true } },
                { id: 'poh-example-r44-cadet', data: { name: 'POH Example - R44 Cadet', model: 'Robinson R44 Cadet', emptyWeight: 1460, emptyWeightCG: 106.2, emptyWeightLatCG: 0.2, hasAuxTank: true, colorHue: 50, colorEnabled: true } },
                { id: 'poh-example-r66', data: { name: 'POH Example - R66', model: 'Robinson R66', emptyWeight: 1290, emptyWeightCG: 109.0, emptyWeightLatCG: 0.33, hasAuxTank: false, colorHue: 270, colorEnabled: true } }
            ];

            profilesToCreate.forEach(async (profile) => {
                 try {
                    await setDoc(doc(db, 'users', appState.userId, 'aircraft', profile.id), profile.data);
                } catch (error) {
                    console.error("Error creating default profile:", error);
                }
            });
        }

        function attachFirestoreListener() {
            if (appState.unsubscribe) appState.unsubscribe();
            if (!db || !appState.userId) return;

            const collectionRef = collection(db, 'users', appState.userId, 'aircraft');
            appState.unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                if (snapshot.empty && !localStorage.getItem('defaultsCreated')) {
                    createDefaultProfiles();
                    localStorage.setItem('defaultsCreated', 'true');
                }
                appState.profiles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(appState.currentScreen === 'profileList') {
                    renderProfileList();
                }
            }, (error) => console.error("Firestore listener error:", error));
        }

        async function handleSaveProfile(e) {
            e.preventDefault();
            const id = document.getElementById('profile-id').value || crypto.randomUUID();
            const profileData = {
                name: document.getElementById('profile-name').value,
                model: document.getElementById('aircraft-model').value,
                emptyWeight: parseFloat(document.getElementById('empty-weight').value),
                emptyWeightCG: parseFloat(document.getElementById('empty-weight-cg').value),
                emptyWeightLatCG: parseFloat(document.getElementById('empty-weight-lat-cg').value),
                hasAuxTank: document.getElementById('has-aux-tank').checked,
                colorHue: parseInt(document.getElementById('profile-color').value),
                colorEnabled: document.getElementById('enable-color-checkbox').checked
            };

            if (!profileData.name || !profileData.model || !profileData.emptyWeight || !profileData.emptyWeightCG || isNaN(profileData.emptyWeightLatCG)) {
                alert("Please fill out all fields with valid numbers.");
                return;
            }

            try {
                await setDoc(doc(db, 'users', appState.userId, 'aircraft', id), profileData, { merge: true });
                navigate('profileList');
            } catch (error) {
                console.error("Error saving profile:", error);
            }
        }
        
        async function handleDeleteProfile() {
            const id = document.getElementById('profile-id').value;
            if (!id) return;
            
            if (confirm('Are you sure you want to delete this profile?')) {
                 try {
                    await deleteDoc(doc(db, 'users', appState.userId, 'aircraft', id));
                    navigate('profileList');
                } catch (error) {
                    console.error("Error deleting profile:", error);
                }
            }
        }

        // --- INITIALIZATION ---
        function init() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    appState.userId = user.uid;
                    appState.isAuthReady = true;
                    attachFirestoreListener();

                    if (localStorage.getItem('disclaimerAcknowledged') === 'true') {
                        navigate('profileList');
                    } else {
                        document.getElementById('disclaimer-modal').classList.remove('hidden');
                        screens.loading.classList.add('opacity-0');
                        setTimeout(() => screens.loading.classList.add('hidden'), 150);
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous sign-in failed:", error);
                        screens.loading.innerHTML = '<p class="text-red-500">Authentication Failed. Please check Firebase rules and authorized domains.</p>';
                    }
                }
            });
        }

        // --- EVENT LISTENERS ---
        document.getElementById('add-new-profile-btn').addEventListener('click', () => showEditScreen());
        document.getElementById('cancel-edit-btn').addEventListener('click', () => navigate('profileList'));
        profileForm.addEventListener('submit', handleSaveProfile);
        deleteProfileBtn.addEventListener('click', handleDeleteProfile);
        document.getElementById('back-to-list-btn').addEventListener('click', () => navigate('profileList'));
        document.getElementById('recommended-fuel-btn').addEventListener('click', handleRecommendedFuel);
        document.getElementById('info-btn').addEventListener('click', () => document.getElementById('disclaimer-modal').classList.remove('hidden'));
        document.getElementById('aircraft-model').addEventListener('change', updateAuxTankControls);
        
        document.getElementById('acknowledge-disclaimer-btn').addEventListener('click', () => {
            localStorage.setItem('disclaimerAcknowledged', 'true');
            document.getElementById('disclaimer-modal').classList.add('hidden');
            if (appState.currentScreen !== 'profileList') {
                 navigate('profileList');
            }
        });
        
        const doorsToggle = document.getElementById('doors-toggle');
        doorsToggle.addEventListener('change', () => {
            document.getElementById('doors-toggle-label').textContent = doorsToggle.checked ? 'Doors On' : 'Doors Off';
        });

        const allInputIds = [
            'r22-pilot-weight', 'r22-passenger-weight', 'r22-baggage-right', 'r22-baggage-left',
            'r44-pilot-weight', 'r44-fwd-pax-weight', 'r44-fwd-bag-right', 'r44-fwd-bag-left', 'r44-aft-pax-right', 'r44-aft-pax-left',
            'r66-pilot-weight', 'r66-fwd-pax-weight', 'r66-aft-pax-left', 'r66-aft-pax-center', 'r66-aft-pax-right', 'r66-baggage-weight',
            'main-fuel-slider', 'aux-fuel-slider',
            'doors-toggle'
        ];
        allInputIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', () => {
                    updateCalculation();
                });
            }
        });
        
        // --- START APP ---
        init();
    </script>
</body>
</html>

